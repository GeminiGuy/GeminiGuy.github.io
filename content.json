{"meta":{"title":"éš”å£è€ç‹çš„Blog","subtitle":null,"description":"å˜˜ï¼Œè¦å‘è½¦äº†","author":"Gemini","url":"https://geminiguy.github.io"},"pages":[{"title":"categories","date":"2017-01-14T09:04:41.000Z","updated":"2017-01-14T09:12:51.000Z","comments":false,"path":"categories/index.html","permalink":"https://geminiguy.github.io/categories/index.html","excerpt":"","text":""},{"title":"tags","date":"2017-01-14T05:54:18.000Z","updated":"2017-01-14T06:02:54.000Z","comments":false,"path":"tags/index.html","permalink":"https://geminiguy.github.io/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"Kafka Offsetå€’å›å’Œæ•°æ®ä¸¢å¤±ï¼Ÿ","slug":"kafka-offset-rewinds-offset-lost","date":"2017-02-27T16:00:00.000Z","updated":"2017-03-02T03:27:00.000Z","comments":true,"path":"2017/02/28/kafka-offset-rewinds-offset-lost/","link":"","permalink":"https://geminiguy.github.io/2017/02/28/kafka-offset-rewinds-offset-lost/","excerpt":"åºè¨€Kafka Offset Rewindsæ˜¯ä»€ä¹ˆï¼ŸKafkaæ•°æ®ä¸¢å¤±åˆç”±å“ªäº›åŸå› é€ æˆï¼Ÿå¦‚æœè¯»è€…å¯¹è¿™äº›é—®é¢˜äº†å¦‚æŒ‡æŒï¼Œé‚£ä¹ˆå¤§ç¥èµ°å¥½ä¸é€ï¼Œè¿™ç¯‡æ–‡ç« å¯ä»¥ä¸ç”¨æµªè´¹æ—¶é—´äº†ã€‚æœ¬æ–‡é¦–å…ˆå¯¹æˆ‘ä»¬ä¸šåŠ¡ç”Ÿäº§ç¯å¢ƒä¸­é‡åˆ°çš„offset rewindsé—®é¢˜åšä¸€ä¸ªè¯¦å°½åˆ†æï¼Œæ¥ç€å¼•å‡ºkafkaæ•°æ®ä¸¢å¤±çš„å„ç§æƒ…å†µã€‚OKï¼ŒåºŸè¯å°‘è¯´ï¼Œæˆ³æˆ‘ï¼ŒğŸ”½é˜…è¯»å…¨æ–‡ã€‚","text":"åºè¨€Kafka Offset Rewindsæ˜¯ä»€ä¹ˆï¼ŸKafkaæ•°æ®ä¸¢å¤±åˆç”±å“ªäº›åŸå› é€ æˆï¼Ÿå¦‚æœè¯»è€…å¯¹è¿™äº›é—®é¢˜äº†å¦‚æŒ‡æŒï¼Œé‚£ä¹ˆå¤§ç¥èµ°å¥½ä¸é€ï¼Œè¿™ç¯‡æ–‡ç« å¯ä»¥ä¸ç”¨æµªè´¹æ—¶é—´äº†ã€‚æœ¬æ–‡é¦–å…ˆå¯¹æˆ‘ä»¬ä¸šåŠ¡ç”Ÿäº§ç¯å¢ƒä¸­é‡åˆ°çš„offset rewindsé—®é¢˜åšä¸€ä¸ªè¯¦å°½åˆ†æï¼Œæ¥ç€å¼•å‡ºkafkaæ•°æ®ä¸¢å¤±çš„å„ç§æƒ…å†µã€‚OKï¼ŒåºŸè¯å°‘è¯´ï¼Œæˆ³æˆ‘ï¼ŒğŸ”½é˜…è¯»å…¨æ–‡ã€‚ Kafka Offset RewindsOffset Rewindsæ¦‚å¿µKafkaçš„æŸä¸ªgroupçš„æŸä¸ªconsumerè¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰ç”±Coordinatoråˆ†é…äº†æ¶ˆè´¹ä»»åŠ¡å»fetchæŸä¸ªåˆ†åŒºçš„æ•°æ®åï¼Œä¼šæ ¹æ®è¯¥groupæäº¤çš„offsetå»å†³å®šä»åˆ†åŒºçš„å“ªä¸ªåç§»ä½ç½®å»å¼€å§‹æ¶ˆè´¹ã€‚å½“ç„¶ï¼Œå¦‚æœè¿™æ˜¯ä¸€ä¸ªæ–°çš„groupè¿˜æ²¡æœ‰æäº¤è¿‡offsetï¼Œæˆ–è€…ä¹‹å‰æäº¤çš„offsetå‘ç”Ÿäº†è¶Šç•Œé”™è¯¯ï¼Œæ¯”å¦‚offsetå¯¹åº”çš„ä½ç§»ç”±äºå·²è¿‡æœŸæ—¥å¿—æ•°æ®å·²è¢«åˆ é™¤ï¼Œå†æ¯”å¦‚ï¼Œä½ æƒ³pollçš„é‚£ä¸ªä½ç§»å¤„çš„æ•°æ®è¿˜æ²¡æœ‰å†™å…¥leaderï¼ˆwtfï¼Ÿè¿™æ˜¯æœ‰å¯èƒ½çš„ï¼Œæ­£æ˜¯æœ¬æ–‡ç°è±¡æ‰€è®¨è®ºçš„ï¼Œåˆ«æ€¥ï¼Œå¾€ä¸‹çœ‹ï¼‰ã€‚å°±ä¼šæ ¹æ®ä½ çš„consumerå®ä¾‹åˆå§‹åŒ–æ—¶è®¾ç½®çš„auto.offset.resetå‚æ•°å†³å®šå¤„ç†æ–¹å¼ã€‚è®¾ç½®ä¸ºearliestï¼Œä»leaderèƒ½è·å–çš„æœ€å°çš„ä½ç§»åç§»é‡å¼€å§‹æ‹‰å–æ•°æ®ï¼Œé€ æˆå¤§é‡é‡å¤æ¶ˆè´¹ã€‚lateståˆ™è‡ªåŠ¨åˆå§‹åŒ–ä¸ºæœ€æ–°çš„ä½ç§»åç§»é‡å¤„pollæ•°æ®è¿›è¡Œæ¶ˆè´¹ï¼Œå­˜åœ¨ä¸¢å¤±æ•°æ®çš„å¯èƒ½æ€§ã€‚è€Œæœ¬æ–‡çš„offset rewindsä¸»è¦æ˜¯æŒ‡offsetä½ç§»åç§»é‡å€’å›åˆ°æœ€æ—©çš„ä¸€æ¡æ•°æ®å¼€å§‹æ¶ˆè´¹è¿™ç§ç°è±¡ã€‚ ç°è±¡reviewåŠæ’æŸ¥å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªé—®é¢˜æ˜¯å¦‚ä½•è¢«ç›‘æ§åˆ°çš„ï¼Œæˆ‘ä»¬çš„åŒå­¦å¯¹äºwb_userdata_ffk03æ–°å¼€äº†ä¸ªgroupï¼Œå°†æ¶ˆè´¹åˆ°çš„æ•°æ®å†™å…¥influxdbå¹¶åŸºäºGrafanaè¿›è¡Œäº†ç›‘æ§ï¼Œå¯ä»¥çœ‹åˆ°æŸå¤©æ™šä¸Š19ï¼š00å·¦å³çš„æ—¶å€™æ¶ˆè´¹çš„æ•°æ®é‡æ¯”ä¹‹å‰çªå¢äº†äº”å€ï¼ŒåŒæ—¶Burrowä¹Ÿå‘å‡ºäº†lagå †ç§¯æŠ¥è­¦ï¼ŒæŸ¥çœ‹Kafka-managerä¹Ÿå¯ä»¥çœ‹åˆ°å‡ ä¸ªå †ç§¯çš„åˆ†åŒºåœ¨åŒä¸€ä¸ªbrokerä¸Šé¢ã€‚ç§ç§ç°è±¡è¯´æ˜äº†æˆ‘ä»¬çš„groupå‘ç”Ÿäº†offset rewindsï¼Œä»å¤´å¼€å§‹æ¶ˆè´¹ã€‚ä»¥topicï¼šwb_userdata_ffk03ï¼Œpartitionï¼š19ï¼ŒARï¼š[2,3]ï¼ŒISRï¼š[2,3], leaderï¼š2ä¸ºä¾‹ã€‚å»ç›¸åº”çš„brokerä¸Šé¢è¿›è¡Œæ—¥å¿—æ’æŸ¥ï¼Œçœ‹çœ‹7ç‚¹å·¦å³åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚broker 2çš„controller.logæ˜¾ç¤ºå¦‚ä¸‹ï¼šbroker 1çš„controller.logä»ä¸Šé¢ä¸¤å¼ æˆªå›¾å¯ä»¥çœ‹åˆ°broker 2åœ¨18:58:54æ—¶é‡æ–°åŠ å…¥äº†ï¼Œè¯´æ˜ä¹‹å‰è¯¥ç»“ç‚¹è¢«åˆ è¿‡é¢ï¼Œé‚£ç¬¬äºŒå¼ æˆªå›¾ä¸ºä½•æ²¡æœ‰æ‰“å°deleted brokerså‘¢ï¼Œåªæœ‰ä¸€ä¸ªåŸå› ï¼Œbroker 2æ­¤æ—¶è¿˜æ˜¯controllerï¼Œå›§å•Šã€‚ä¸è¿‡æ²¡æœ‰å…³ç³»ï¼Œä¸‹é¢è¿™å¼ æˆªå›¾broker 2 controllerçš„æ—¥å¿—æ˜ç¡®éªŒè¯äº†æ­¤æ—¶broker 2 session timeoutï¼Œbroker failureå–½ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬èƒ½å¤Ÿç¡®ä¿¡è¿™ä¸ªæ—¶é—´ç‚¹ï¼Œè¿™ä¸ªåˆ†åŒºçš„leader 2ç¡®å®failureäº†ï¼Œä½†æ˜¯ä¸ºä½•ä¼šå‡ºç°offset rewindså‘¢ï¼Ÿæ‚²å‰§ç»§ç»­ä¸Šæ¼”â€¦â€¦ è¿™å¼ æˆªå›¾æ˜¯broker 2çš„server.logï¼Œå¯ä»¥çœ‹åˆ°è¿™æ—¶å€™replica 3ä»ISRä¸­è¢«è¸¢å‡ºå»äº†ï¼Œæ­¤æ—¶ISRä¸­å°±åªæœ‰2äº†ï¼Œæ¥ç€leader 2åˆå‘ç”Ÿäº†å®•æœºğŸ˜¶ã€‚ å…³äºè¿™ä¸ªISRçŠ¶æ€çš„å˜åŒ–æˆ‘å†å¤šè¯´ä¸€ç‚¹ã€‚ä»€ä¹ˆæƒ…å†µä¸‹ä¸€ä¸ªreplicaä¼šè¢«ä»ISRä¸­è¸¢å‡ºå»å‘¢ï¼Ÿå…ˆå¤§ä½“çœ‹ä¸€ä¸‹maybeShrinkIsrå’ŒgetOutOfSyncReplicasä¸¤ä¸ªå‡½æ•°ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647 def maybeShrinkIsr(replicaMaxLagTimeMs: Long) &#123; val leaderHWIncremented = inWriteLock(leaderIsrUpdateLock) &#123; leaderReplicaIfLocal() match &#123; case Some(leaderReplica) =&gt; val outOfSyncReplicas = getOutOfSyncReplicas(leaderReplica, replicaMaxLagTimeMs) if(outOfSyncReplicas.size &gt; 0) &#123; val newInSyncReplicas = inSyncReplicas -- outOfSyncReplicas assert(newInSyncReplicas.size &gt; 0) info(\"Shrinking ISR for partition [%s,%d] from %s to %s\".format(topic, partitionId,inSyncReplicas.map(_.brokerId).mkString(\",\"),newInSyncReplicas.map(_.brokerId).mkString(\",\"))) // update ISR in zk and in cache updateIsr(newInSyncReplicas) // we may need to increment high watermark since ISR could be down to 1 replicaManager.isrShrinkRate.mark() maybeIncrementLeaderHW(leaderReplica) &#125; else &#123; false &#125; case None =&gt; false // do nothing if no longer leader &#125; &#125; // some delayed operations may be unblocked after HW changed if (leaderHWIncremented) tryCompleteDelayedRequests()&#125;def getOutOfSyncReplicas(leaderReplica: Replica, maxLagMs: Long): Set[Replica] = &#123; /** * there are two cases that will be handled here - * 1. Stuck followers: If the leo of the replica hasn't been updated for maxLagMs ms, * the follower is stuck and should be removed from the ISR * 2. Slow followers: If the replica has not read up to the leo within the last maxLagMs ms, * then the follower is lagging and should be removed from the ISR * Both these cases are handled by checking the lastCaughtUpTimeMs which represents * the last time when the replica was fully caught up. If either of the above conditions * is violated, that replica is considered to be out of sync * **/ val leaderLogEndOffset = leaderReplica.logEndOffset val candidateReplicas = inSyncReplicas - leaderReplica val laggingReplicas = candidateReplicas.filter(r =&gt; (time.milliseconds - r.lastCaughtUpTimeMs) &gt; maxLagMs) if(laggingReplicas.size &gt; 0) debug(\"Lagging replicas for partition %s are %s\".format(TopicAndPartition(topic, partitionId), laggingReplicas.map(_.brokerId).mkString(\",\"))) laggingReplicas&#125; åœ¨getOutOfSyncReplicaså‡½æ•°çš„æ³¨é‡Šä¸­æŠŠreplicaå‰”é™¤ISRçš„æƒ…å†µè¯´çš„æ¯”è¾ƒæ¸…æ¥šã€‚ 1. è¿™ä¸ªreplica fetchçš„è¿›ç¨‹stuckä½äº†ï¼Œè¯¥replicaçš„leoè¶…è¿‡maxLagMsæ²¡æœ‰æ›´æ–°äº†ã€‚ 2. followerçš„æ‹·è´é€Ÿåº¦è¿œè¿œè·Ÿä¸ä¸Šleaderçš„å†™å…¥é€Ÿåº¦ï¼Œå·²ç»æŒç»­è½åäº†maxLagMs è¿™ä¸¤ç§æƒ…å†µéƒ½å¯ä»¥ç”¨lastCaughtUpTimeMsæ¥è®¡æ—¶ï¼Œè¿™ä¸ªå‚æ•°ä»£è¡¨äº†è¿™ä¸ªreplicaä¸Šä¸€æ¬¡å®Œå…¨è¿½ä¸Šleaderçš„æ—¶é—´æˆ³ã€‚ æ¥ç€æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ISRä¸­åªå‰©ä¸‹2ï¼Œè€Œ2åˆå®•æœºäº†ï¼Œè‚¿ä¹ˆåŠï¼Œå…¶å®æ­¤åˆ»è¯¥åˆ†åŒºè¿˜æ˜¯å¯ä»¥ç”¨çš„ï¼Œå› ä¸ºé»˜è®¤å¼€å¯äº†unclean.leader.election.enableè¿™ä¸ªåŠŸèƒ½ï¼Œå…è®¸è¿›è¡Œuncleané€‰ä¸¾ï¼Œæœªèƒ½åŠæ—¶åŒæ­¥çš„replica 3è¢«é€‰ä¸¾ä¸ºleaderï¼Œå¯ä»¥çœ‹å¦‚ä¸‹æ—¥å¿—ã€‚å‘ç”Ÿuncleané€‰ä¸¾çš„å±å®³ä¸åªåœ¨offsetä¼šå‘ç”Ÿå€’é€€ï¼Œè€Œä¸”æœªèƒ½åŒæ­¥åˆ°replicaçš„æ•°æ®åŸºæœ¬ä¸Šå°±ä¸¢å¤±äº†ã€‚é‚£ä¹ˆæŠŠè¿™ä¸ªåŠŸèƒ½å…³äº†ä¸å°±okäº†å—ï¼Ÿè‡ªå¤ç¾äº‹ä¸¤éš¾å…¨ï¼Œæˆ‘ä»¬åœ¨ä¸‹ä¸€èŠ‚æ¥ç»†è¯´è¿™ä¸ªUnclean leader electionã€‚ å…¶ä»–é—®é¢˜å…¶å®é€ æˆoffset rewindsçš„é—®é¢˜æ˜¯å¹¶ä¸å±€é™äºunclean leader electionï¼Œå‰–æLinkedlné­é‡çš„Kafkaâ€œå±æœºæ•…éšœâ€è¿™ç¯‡æ–‡ç« ä¸­ä¹Ÿä»‹ç»äº†LinkedInä¹‹å‰é‡åˆ°çš„ä¸€äº›Bugçº§åˆ«ï¼ˆç›®å‰å·²ä¿®å¤ï¼‰çš„offset rewindsï¼Œä»¥ä¾›å‚è€ƒã€‚ Kafkaæ•°æ®ä¸¢å¤±ï¼ŸUnclean leader electionæ˜¯å¦å…è®¸uncleané€‰ä¸¾å…¶å®ä¹Ÿæ˜¯å¯ç”¨æ€§å’Œæ•°æ®ä¸€è‡´æ€§çš„trade-offé—®é¢˜ã€‚å®˜æ–¹æ–‡æ¡£é’ˆå¯¹uncleané€‰ä¸¾æœ‰è¿™ä¹ˆä¸€æ®µï¼Œæˆ‘ç»“åˆè‡ªå·±çš„ç†è§£æ¥ç¿»è¯‘ä¸€ä¸‹ã€‚ Unclean leader election: What if they all die?Note that Kafkaâ€™s guarantee with respect to data loss is predicated on at least one replica remaining in sync. If all the nodes replicating a partition die, this guarantee no longer holds.However a practical system needs to do something reasonable when all the replicas die. If you are unlucky enough to have this occur, it is important to consider what will happen. There are two behaviors that could be implemented: Wait for a replica in the ISR to come back to life and choose this replica as the leader (hopefully it still has all its data). Choose the first replica (not necessarily in the ISR) that comes back to life as the leader. This is a simple tradeoff between availability and consistency. If we wait for replicas in the ISR, then we will remain unavailable as long as those replicas are down. If such replicas were destroyed or their data was lost, then we are permanently down. If, on the other hand, a non-in-sync replica comes back to life and we allow it to become leader, then its log becomes the source of truth even though it is not guaranteed to have every committed message. By default Kafka chooses the second strategy and favor choosing a potentially inconsistent replica when all replicas in the ISR are dead. This behavior can be disabled using configuration property unclean.leader.election.enable, to support use cases where downtime is preferable to inconsistency. This dilemma is not specific to Kafka. It exists in any quorum-based scheme. For example in a majority voting scheme, if a majority of servers suffer a permanent failure, then you must either choose to lose 100% of your data or violate consistency by taking what remains on an existing server as your new source of truth. éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œkafkaå¯¹äºæ•°æ®ä¸¢å¤±çš„ä¿éšœæ˜¯åŸºäºISRä¸­è‡³å°‘ä¸€ä¸ªå‰¯æœ¬åœ¨ä¿æŒåŒæ­¥ã€‚å¦‚æœè¯¥åˆ†åŒºä¸Šæ‰€æœ‰çš„å‰¯æœ¬ç»“ç‚¹éƒ½æŒ‚äº†ï¼Œé‚£è¿™ä¿è¯å°±ä¸å†æˆç«‹äº†ã€‚ç„¶åå®é™…ç³»ç»Ÿéœ€è¦å¯¹æ‰€æœ‰replica dieçš„æƒ…å†µè¿›è¡Œå¤„ç†ã€‚å¦‚æœä½ äººå“ä¸å¥½é‡åˆ°äº†è¿™ç§æƒ…å†µï¼Œéœ€è¦è€ƒè™‘ä»¥ä¸‹ä¸¤ç§å¤„ç†æ–¹å¼ï¼Œå°±å˜å¾—è‡³å…³é‡è¦äº†ï¼š ç­‰ç€ISRä¸­çš„ä¸€ä¸ªå‰¯æœ¬æ´»è¿‡æ¥ï¼Œå¹¶é€‰ä¸¾å®ƒä¸ºleader é€‰æ‹©ç¬¬ä¸€ä¸ªæ´»è¿‡æ¥çš„å‰¯æœ¬ï¼ˆä¸ä¸€å®šåœ¨ISRä¸­ï¼‰ä½œä¸ºleader å…¶å®è¿™å°±æ˜¯é’ˆå¯¹å¯ç”¨æ€§å’Œä¸€è‡´æ€§çš„ç®€å•æƒè¡¡äº†ã€‚å¦‚æœé€‰æ‹©ç­‰å¾…ISRä¸­çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œé‚£ä¹ˆåªè¦ISRä¸­çš„replicaä¸€ç›´downï¼Œokï¼Œé‚£ä¹ˆè¿™ä¸ªåˆ†åŒºå°±ä¸å¯ç”¨ï¼Œå¦‚æœè¿™äº›replicaæŸåæˆ–è€…æ•°æ®ä¸¢å¤±ï¼ˆç®¡å®ƒä»€ä¹ˆåŸå› ï¼‰ï¼Œé‚£å°±æ˜¯æ°¸ä¹…çš„ä¸å¯ç”¨äº†ã€‚å¦ä¸€ä¸ªæ–¹é¢ï¼Œå¦‚æœæˆ‘ä»¬é€‰æ‹©äº†ä¸€ä¸ªä¸æ˜¯ISRä¸­çš„replicaä½œä¸ºleaderï¼Œé‚£å®ƒçš„logå°†æˆä¸ºæ•°æ®æºï¼Œå³ä½¿å®ƒçš„logä¸­å¹¶ä¸èƒ½å¤Ÿä¿è¯æ‹¥æœ‰æ¯æ¡å·²ç»è¢«commitedçš„æ¶ˆæ¯ã€‚ç›®å‰æˆ‘ä»¬ç”¨çš„ç‰ˆæœ¬ä¸­é»˜è®¤æ˜¯é€‰æ‹©äº†ç¬¬äºŒç§å¤„ç†æ–¹å¼ï¼Œå¦‚æœISRä¸­çš„æ‰€æœ‰replicaæŒ‚äº†å°±é€‰æ‹©äº†ä¸€ä¸ªæ½œåœ¨æ•°æ®ä¸ä¸€è‡´çš„replicaä½œä¸ºleaderã€‚å¦‚æœæˆ‘ä»¬å¯¹äºæ•°æ®ä¸€è‡´æ€§çš„è¦æ±‚æ¯”å®•æœºå¯ç”¨æ€§çš„è¦æ±‚æ›´é«˜ï¼Œå°±å¯ä»¥é€šè¿‡unclean.leader.election.enable=falseç¦ç”¨æ‰ï¼Œè¿™ä¸ªå¯ä»¥ç»†åŒ–åˆ°æŸä¸ªtopicçº§åˆ«ã€‚è¿™é‡Œæˆ‘å¤šè¯´ä¸€å¥ä»€ä¹ˆæ˜¯committedæ¶ˆæ¯ï¼Œå¦‚æœä¸€æ¡æ¶ˆæ¯è¢«ISRä¸­æ‰€æœ‰çš„replicaè®°å½•åˆ°logä¸­ï¼Œé‚£ä¹ˆè¿™æ¡æ¶ˆæ¯å°±è¢«è®¤ä¸ºæ˜¯committedçš„ï¼Œå¯¹äºconsumerç«¯è€Œè¨€ï¼Œåªæœ‰è¢«committedçš„æ¶ˆæ¯æ‰èƒ½è¢«çœ‹åˆ°ï¼Œè€ŒHigh Watermarkå°±æ˜¯æœ€æ–°çš„çš„ä¸€æ¡committed messageçš„ä½ç§»ã€‚è¿™ç§çª˜å¢ƒä¹Ÿä¸åªKafkaå­˜åœ¨ï¼Œä»»ä½•åŸºäºquorumçš„æ–¹æ¡ˆä¸­éƒ½ä¼šå­˜åœ¨ã€‚ä¾‹å¦‚åœ¨å¤šæ•°æŠ•ç¥¨çš„æ–¹æ¡ˆä¸­ï¼Œå¦‚æœå¤šæ•°çš„æœåŠ¡å™¨å°†å¯èƒ½æ°¸ä¹…ä¸å¯ç”¨ï¼Œä½ æ˜¯é€‰æ‹©100%ä¸¢å¤±æ•°æ®å‘¢ï¼Ÿè¿˜æ˜¯è¿åä¸€è‡´æ€§ï¼Œç”¨å¹¸å­˜çš„æœåŠ¡å™¨ä¸Šè¿˜æœ‰çš„æ•°æ®ä½œä¸ºæ–°çš„æ•°æ®æºï¼Ÿ Producerç«¯æ•°æ®ä¸¢å¤±ï¼Ÿæ—¢ç„¶åœ¨æœªåŒæ­¥çš„replicaä¸­é€‰ä¸¾leaderä¼šå‘ç”Ÿæ•°æ®ä¸¢å¤±ï¼Œé‚£ä¹ˆä»ISRä¸­è¿›è¡Œleaderé€‰ä¸¾æ˜¯å¦å°±100%ä¿è¯æ•°æ®å®Œæ•´äº†å‘¢ï¼ŸNative~~æˆ‘ä»¬å†æ¥çœ‹è¿™ç§æƒ…å†µï¼šACK=1ï¼ŒISR=(1,2,3), leader=1replica 1ä½œä¸ºleaderå·²ç»ç¡®è®¤äº†producerçš„ä¸€äº›recordså†™å…¥local logï¼Œå¹¶æˆåŠŸè¿”å›ç»™äº†producerå“åº”ã€‚æ­¤æ—¶leader failureï¼Œä¸”follower 2å’Œ3è¿˜æ²¡æ¥å¾—åŠå¤åˆ¶è¿™äº›recordsã€‚é‡æ–°é€‰ä¸¾ï¼ŒISR=(2,3)ï¼Œå…¶ä¸­2å½“é€‰leaderï¼ŒmakeLeaderçš„è¿‡ç¨‹ä¸­HWè¿˜æ˜¯ä¿æŒäº†ä¹‹å‰çš„æ—§å€¼ã€‚æ¥ç€1æ´»è¿‡æ¥äº†ï¼Œæˆä¸ºfollowerï¼Œæˆªæ–­è‡ªå·±çš„logè‡³HWï¼Œreplica 1çš„HWè‡³leoçš„æ•°æ®ä¹Ÿå°±è¢«æŠ›å¼ƒäº†ï¼Œå› æ­¤ä¹‹å‰å†™å…¥replica 1ä½†è¿˜æœªåŒæ­¥åˆ°replica 2çš„æ•°æ®ä¹Ÿå°±å½»åº•ä¸¢å¤±äº†ã€‚replica 1æ²¡æœ‰æ´»è¿‡æ¥ï¼Œå½“ç„¶æ•°æ®ä¹Ÿä¸¢å¤±äº†ã€‚è§£å†³åŠæ³•æ˜¯ï¼Œproducerç«¯è®¾ç½®ACK=all(-1)ï¼Œbrokerç«¯é’ˆå¯¹å…·ä½“çš„topicè®¾ç½®min.insync.replicas=2ï¼Œè¿™æ ·produceråªæœ‰ç­‰å¾…ISRä¸­è‡³å°‘ä¸¤ä¸ªreplicaå·²ç»ç¡®è®¤å†™å…¥äº†è¿™æ¡æ¶ˆæ¯ï¼Œæ‰ä¼šç»™producerè¿”å›æ­£ç¡®å“åº”ã€‚å¦‚æœè¯¥æ¡ä»¶æ— æ³•æ»¡è¶³ï¼Œåˆ™è§¦å‘å¼‚å¸¸ã€‚å½“ç„¶äº†ï¼Œproducerç«¯è¿™ä¹ˆè®¾ç½®ä¹‹åï¼Œæ•°æ®å®Œæ•´æ€§æ˜æ˜¾é«˜äº†è®¸å¤šï¼Œæ¢æ¥çš„å¿…ç„¶æ˜¯ååé‡çš„ä¸‹é™ï¼Œå“ï¼Œè¿™åˆæ˜¯ä¸€ä¸ªtrade-offçš„é—®é¢˜å•Šã€‚ æ€»ç»“æœ¬æ–‡é’ˆå¯¹unclean leaderé€‰ä¸¾é€ æˆçš„offset rewindsæƒ…å†µè¿›è¡Œäº†å®é™…çš„åˆ†æï¼Œè¿›è€Œå¼•å‡ºäº†kafkaä¸¢å¤±æ•°æ®çš„å„ç§æƒ…å†µã€‚Howeverï¼Œé’ˆå¯¹ä¸åŒçš„ä¸šåŠ¡åœºæ™¯è¿›è¡Œå¯ç”¨æ€§ä¸æ•°æ®ä¸€è‡´æ€§çš„æƒè¡¡ã€ååé‡ä¸æ•°æ®å®Œæ•´æ€§çš„æƒè¡¡ï¼Œæ˜¯éå¸¸é‡è¦çš„ã€‚å½“ç„¶ï¼Œæœ€é‡è¦çš„è¿˜æ˜¯ä¿è¯Kafkaé›†ç¾¤çš„çš„ç¨³å®šå’Œå¥åº·ã€‚","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://geminiguy.github.io/categories/æŠ€æœ¯/"}],"tags":[{"name":"Kafka","slug":"Kafka","permalink":"https://geminiguy.github.io/tags/Kafka/"},{"name":"æ•°æ®ä¸€è‡´æ€§","slug":"æ•°æ®ä¸€è‡´æ€§","permalink":"https://geminiguy.github.io/tags/æ•°æ®ä¸€è‡´æ€§/"},{"name":"é«˜å¯ç”¨æ€§","slug":"é«˜å¯ç”¨æ€§","permalink":"https://geminiguy.github.io/tags/é«˜å¯ç”¨æ€§/"}]},{"title":"å‘¨æœ«çæ‰¯æ·¡","slug":"å‘¨æœ«çæ‰¯æ·¡","date":"2017-02-25T16:00:00.000Z","updated":"2017-02-28T12:34:57.000Z","comments":true,"path":"2017/02/26/å‘¨æœ«çæ‰¯æ·¡/","link":"","permalink":"https://geminiguy.github.io/2017/02/26/å‘¨æœ«çæ‰¯æ·¡/","excerpt":"åºè¨€å‘¨æœ«çæ‰¯æ·¡ï¼Œè®°ä¸ªæµæ°´è´¦ã€‚","text":"åºè¨€å‘¨æœ«çæ‰¯æ·¡ï¼Œè®°ä¸ªæµæ°´è´¦ã€‚ è€ç‹ç§æˆ¿èœæ¯å‘¨ç»§ç»­åšæŒåšä¸€é“æ–°èœï¼Œå‘¨å…­åƒå®Œçƒ¤è‚‰ï¼Œå‘¨æ—¥åƒç‚¹ç´ å§ã€‚è¥¿è‘«èŠ¦ç‚’è¥¿çº¢æŸ¿ï¼Œå‘³é“è¿˜æ˜¯å¾ˆä¸é”™çš„ã€‚Psï¼šmdï¼Œæƒ³è¯•ç€åšç‚’é¢ï¼Œä¸Šå‘¨é‚£ç§æ¹¿é¢å·®ç‚¹åˆæŠŠæˆ‘çš„ç‚’é”…ç»™æ¯äº†ï¼Œæ—¥äº†ğŸ©äº†ï¼Œæœæ–­å¼ƒä¹‹~~ æ„å¤–å‘ç°å‘¨å…­æ—©æ™¨èººåºŠä¸Šè¢«å¾®åšçš„ä¸€ä¸ªæ¸¸æˆè§†é¢‘å¹¿å‘Šå¸å¼•äº†ï¼Œã€Šæ¢¦å¹»è¥¿æ¸¸æ— åŒç‰ˆã€‹ï¼Œä¸‹ä¸‹æ¥ç©äº†ä¸€ä¸‹ï¼Œæ²¡æƒ³åˆ°å†ç»äº†13å¹´çš„å›åˆåˆ¶æ¸¸æˆè¿˜æ˜¯å‡ºäº†å³æ—¶æˆ˜ç•¥ç‰ˆæœ¬å•Šï¼Œå®¹æˆ‘æ€€ä¸ªæ—§~~ è¿˜è®°å¾—å½“å¹´çš„æµ·åº•æ²‰èˆ¹ä¹ˆï¼Œæœ€åçš„bossé‚£é‡Œæ˜¯å¦è¿˜èƒ½é‡åˆ°å¤šå¹´åå˜æˆå¤§ä¾ çš„è‡ªå·±å‘¢ï¼Ÿå·²ç„¶è®°ä¸å¤ªæ¸…æ¥šäº†ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ å¥èº«æ‰“å¡ å‘¨æ—¥è·‘æ­¥æ‰“ä¸ªå¡ï¼Œé€æ¸åŠ é‡å§ï¼Œä¸‹ä¸€å‘¨äº‰å–èƒ½è·‘10çš„é€Ÿåº¦ï¼Œå†åŠ ä¸ª1KMï¼Œæ©ï¼Œæ¯å‘¨åšæŒè‡³å°‘ä¸¤æ¬¡è·‘æ­¥ã€‚","categories":[{"name":"é—²èŠ","slug":"é—²èŠ","permalink":"https://geminiguy.github.io/categories/é—²èŠ/"}],"tags":[{"name":"é—²èŠ","slug":"é—²èŠ","permalink":"https://geminiguy.github.io/tags/é—²èŠ/"}]},{"title":"Kafka Controllerå¡«å‘","slug":"kafka-controller-makeLeader&Follower","date":"2017-02-18T16:00:00.000Z","updated":"2017-02-19T08:54:06.000Z","comments":true,"path":"2017/02/19/kafka-controller-makeLeader&Follower/","link":"","permalink":"https://geminiguy.github.io/2017/02/19/kafka-controller-makeLeader&Follower/","excerpt":"åºè¨€ é˜³å…‰æ˜ç¾æ—¥ï¼Œæ­£æ˜¯å¡«å‘æ—¶ ä¹‹å‰æœ‰ä¸€ç¯‡Kafka Controllerçš„æ–‡ç« ä¸­ï¼Œå¯¹äºRelicaManagerçš„makeLeadersã€makeFollowersæ–¹æ³•å…·ä½“å®ç°é€»è¾‘ç•™äº†ä¸€ä¸ªå‘ï¼Œæ—¶éš”å¥½ä¹…ï¼Œå›æ¥æŠŠè¿™ä¸ªå‘è¡¥ä¸Šï¼Œå…¶ä¸­å‚è€ƒäº†0.10ç‰ˆæœ¬çš„scalaæºç ä»¥åŠä¸¤ç¯‡åšå®¢ï¼Œæœ€åå‚è€ƒæ–‡çŒ®ä¸­ä¼šæœ‰æ³¨æ˜ã€‚","text":"åºè¨€ é˜³å…‰æ˜ç¾æ—¥ï¼Œæ­£æ˜¯å¡«å‘æ—¶ ä¹‹å‰æœ‰ä¸€ç¯‡Kafka Controllerçš„æ–‡ç« ä¸­ï¼Œå¯¹äºRelicaManagerçš„makeLeadersã€makeFollowersæ–¹æ³•å…·ä½“å®ç°é€»è¾‘ç•™äº†ä¸€ä¸ªå‘ï¼Œæ—¶éš”å¥½ä¹…ï¼Œå›æ¥æŠŠè¿™ä¸ªå‘è¡¥ä¸Šï¼Œå…¶ä¸­å‚è€ƒäº†0.10ç‰ˆæœ¬çš„scalaæºç ä»¥åŠä¸¤ç¯‡åšå®¢ï¼Œæœ€åå‚è€ƒæ–‡çŒ®ä¸­ä¼šæœ‰æ³¨æ˜ã€‚ ReplicaManager.makeLeaders é¦–å…ˆå¯¹äºæ¥æ”¶åˆ°makeLeadersè¯·æ±‚çš„brokeræ¥è¯´ï¼Œå¯¹äºæ¯ä¸€ä¸ªæœ¬åœ°çš„replicaå°†æˆä¸ºleaderçš„partitionï¼Œç§»é™¤è¯¥partitionçš„Fetcherï¼Œå› ä¸ºå¦‚æœæœ¬åœ°replicaä¸å†æ˜¯followerï¼Œå°±ä¸éœ€è¦ä»leaderæ‹‰å–æ¶ˆæ¯äº†ã€‚ å¯¹æ¯ä¸ªpartitionè°ƒç”¨partition.makeLeaderæ–¹æ³•ï¼š æ›´æ–°allReplicaåˆ—è¡¨ï¼Œå¯¹äºæ–°å¢çš„replicaè¦åˆ›å»ºlogã€ åˆå§‹åŒ–highWaterç­‰ç­‰ã€‚å¯¹äºå½“å‰åˆ†é…çš„replicaä¸åœ¨allReplicasä¸­ï¼Œåˆ™éœ€è¦ä»assignedReplicasä¸­åˆ é™¤ã€‚ æ›´æ–°Partitionå¯¹è±¡çš„ISRï¼ŒcontrollerEpochï¼ŒleaderEpochï¼ŒzkVersionç­‰ä¿¡æ¯ã€‚ å¦‚æœæœ¬åœ°replicaä¹‹å‰ä¸æ˜¯leaderï¼Œæˆä¸ºäº†leaderï¼Œéœ€è¦æ›´æ–°leader replicaçš„highWaterã€‚ æŠŠæ‰€æœ‰remote replicaçš„leoé‡ç½®äº†æˆUnknownOffsetMetadataï¼ˆ-1ï¼‰ï¼Œåœ¨maybeIncrementLeaderHWä¸­ä¼šå–æ‰€æœ‰replicaä¸­æœ€å°çš„leoï¼Œå¦‚æœé™¤leaderå¤–æœ‰å…¶ä»–replicaï¼Œå› ä¸ºåˆšè¢«é‡ç½®è¿‡ï¼Œæœ€å°leoä¸€å®šæ˜¯-1ï¼Œ-1ä¸€å®šå°äºå½“å‰çš„hwï¼Œæ‰€ä»¥hwå…¶å®ä¸ä¼šè¢«incrementã€‚åªæœ‰å½“isrä¸­åªæœ‰leaderæ—¶ï¼Œé‚£hwä¼šè¢«incrementåˆ°leader.leoã€‚ ReplicaManager.makeFollowers é’ˆå¯¹æœ¬åœ°æ¯ä¸€ä¸ªreplicaå°†æˆä¸ºfollowerçš„åˆ†åŒºï¼Œè°ƒç”¨partition.makeFolloweræ–¹æ³•ã€‚ partition.makeFollowerä¸­ï¼Œæ›´æ–°partitionçš„controllerEpochã€ISRï¼ˆåˆå§‹åŒ–ä¸ºç©ºï¼‰ã€leaderEpochã€zkVersionç­‰ä¿¡æ¯ã€‚ æ›´æ–°allReplicaåˆ—è¡¨ï¼Œå¯¹äºæ–°å¢çš„replicaè¦åˆ›å»ºlogã€ åˆå§‹åŒ–highWaterç­‰ç­‰ã€‚å¯¹äºå½“å‰åˆ†é…çš„replicaä¸åœ¨allReplicasä¸­ï¼Œåˆ™éœ€è¦ä»assignedReplicasä¸­åˆ é™¤ã€‚ å¦‚æœpartitionçš„leaderå‘ç”Ÿå˜åŒ–ï¼Œè¿”å›trueï¼ŒpartitionåŠ å…¥partitionsToMakeFollower setä¸­ï¼Œå¦åˆ™ï¼Œè¿”å›falseã€‚ é’ˆå¯¹partitionsToMakeFollowerï¼Œç§»é™¤æ—§çš„Fetcherã€‚ å¦‚æœleaderå‘ç”Ÿäº†å˜åŒ–ï¼Œä¹‹å‰åŒæ­¥çš„æ•°æ®å’Œæ–°çš„leaderå¯èƒ½ä¸ä¸€è‡´ï¼Œä¹Ÿæœ‰å¯èƒ½ä¹‹å‰ä½œä¸ºleaderçš„leoå¤§äºç°åœ¨leaderçš„leoï¼Œå› æ­¤éœ€è¦æŠŠlogæˆªæ–­è‡³highWaterã€‚ å¦‚æœå½“å‰brokeræ²¡æœ‰åœ¨shuttingDownçš„è¯ï¼Œæ·»åŠ æ–°çš„leaderçš„Fetcher __consumer_offsetsçš„ç‰¹æ®Šæƒ…å†µ partitionä¸­topicä¸º__consumer_offsetsçš„ç‰¹æ®Šæƒ…å†µå¤„ç†ï¼Œå¯¹äºæ–°æˆä¸ºçš„leaderï¼Œè°ƒç”¨coordinator.handleGroupImmigrationæ–¹æ³•ï¼Œè¿›è€Œè°ƒç”¨groupManager.loadGroupsForPartitionæ–¹æ³•ï¼Œå°†ä»logä¸­æŠŠå±äºå½“å‰åˆ†åŒºçš„Offseté¡¹æ¢å¤åˆ°OffsetCacheä¸­ã€‚å¯¹äºæ–°æˆä¸ºçš„followersï¼Œcoordinator.handleGroupEmigrationæ–¹æ³•ä¸­è¿›è€Œè°ƒç”¨groupManager.removeGroupsForPartitionæ–¹æ³•ï¼Œæ¸…é™¤ä¹‹å‰çš„å±äºè¯¥partitionçš„æ¶ˆè´¹è€…ç»„æäº¤çš„offsetç¼“å­˜ã€‚ å‚è€ƒæ–‡çŒ® Kafkaæºç é˜…è¯»-KafkaController(2) Apache Kafkaæºç åˆ†æ - KafkaApis","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://geminiguy.github.io/categories/æŠ€æœ¯/"}],"tags":[{"name":"Kafka Controller","slug":"Kafka-Controller","permalink":"https://geminiguy.github.io/tags/Kafka-Controller/"}]},{"title":"å‘¨å…­æ‚è®°â€”å£¹è´°å","slug":"Note-20170218","date":"2017-02-17T16:00:00.000Z","updated":"2017-02-18T16:14:51.000Z","comments":true,"path":"2017/02/18/Note-20170218/","link":"","permalink":"https://geminiguy.github.io/2017/02/18/Note-20170218/","excerpt":"æ‚è®°å£¹ å›é¡¾è¿™ä¸€å‘¨ï¼Œå¥½åƒéƒ½åœ¨åº”ä»˜å„ç§å°é¡¹ç›®å¼€å‘ï¼Œç²‰æ¡2017å¹´æ”¹ç‰ˆå¤§é¡¹ç›®å¯åŠ¨ï¼Œè®¾è®¡è¯„å®¡ä¼šåŠ å„ç§å¯¹æ¥å£æ ¼å¼åˆæ˜¯ä¸¤å¤©çš„æ—¶é—´ã€‚ç”¨æ¥å­¦ä¹ åŸºç¡€jvmçŸ¥è¯†çš„æ—¶é—´å¤§å¤§è¢«å‹æ¦¨ï¼Œä¹°çš„ã€Šäººç±»ç®€å²ã€‹å’Œã€Šæœªæ¥ç®€å²ã€‹ä¹Ÿæ²‰ç¡äº†å¥½å‡ å¤©ã€‚Howeverï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œæˆ‘çš„é”…ä¹Ÿæ²‰ç¡è®¸ä¹…ï¼Œæ˜¯æ—¶å€™å”¤é†’å®ƒäº†~~ ä¹‹å‰è®¾æƒ³çš„æ˜¯æ¯å‘¨éƒ½å­¦åšä¸€é“æ–°èœï¼Œä¸ä»…æ˜¯å› ä¸ºæˆ‘å¸é£Ÿå ‚å¤ªéš¾åƒï¼Œä¹Ÿæ˜¯è®©è‡ªå·±çš„ç å†œç”Ÿæ´»ä¸è¦è¿‡å¾—å¤ªå±Œä¸å§ï¼Œå¤šä¸€äº›æ­£èƒ½é‡ï¼Œæˆ–è®¸å°±æˆäº†ç¨‹åºçŒ¿ç•Œçš„â€œå¨ç¥â€äº†å‘¢ï¼ŸğŸ˜å‘¨å…­æ—©ä¸Šåè€Œç¡ä¸ä¹…äº†ï¼Œäºæ˜¯ä¹èµ·åºŠä¹°èœï¼Œåœ¨è¶…å¸‚é‡Œçœ‹åˆ°äº†æ–°é²œçš„æ¹¿é¢ï¼Œè¿™æ˜¯ä¸ªæ‚²å‰§çš„å‰æˆâ€¦â€¦","text":"æ‚è®°å£¹ å›é¡¾è¿™ä¸€å‘¨ï¼Œå¥½åƒéƒ½åœ¨åº”ä»˜å„ç§å°é¡¹ç›®å¼€å‘ï¼Œç²‰æ¡2017å¹´æ”¹ç‰ˆå¤§é¡¹ç›®å¯åŠ¨ï¼Œè®¾è®¡è¯„å®¡ä¼šåŠ å„ç§å¯¹æ¥å£æ ¼å¼åˆæ˜¯ä¸¤å¤©çš„æ—¶é—´ã€‚ç”¨æ¥å­¦ä¹ åŸºç¡€jvmçŸ¥è¯†çš„æ—¶é—´å¤§å¤§è¢«å‹æ¦¨ï¼Œä¹°çš„ã€Šäººç±»ç®€å²ã€‹å’Œã€Šæœªæ¥ç®€å²ã€‹ä¹Ÿæ²‰ç¡äº†å¥½å‡ å¤©ã€‚Howeverï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œæˆ‘çš„é”…ä¹Ÿæ²‰ç¡è®¸ä¹…ï¼Œæ˜¯æ—¶å€™å”¤é†’å®ƒäº†~~ ä¹‹å‰è®¾æƒ³çš„æ˜¯æ¯å‘¨éƒ½å­¦åšä¸€é“æ–°èœï¼Œä¸ä»…æ˜¯å› ä¸ºæˆ‘å¸é£Ÿå ‚å¤ªéš¾åƒï¼Œä¹Ÿæ˜¯è®©è‡ªå·±çš„ç å†œç”Ÿæ´»ä¸è¦è¿‡å¾—å¤ªå±Œä¸å§ï¼Œå¤šä¸€äº›æ­£èƒ½é‡ï¼Œæˆ–è®¸å°±æˆäº†ç¨‹åºçŒ¿ç•Œçš„â€œå¨ç¥â€äº†å‘¢ï¼ŸğŸ˜å‘¨å…­æ—©ä¸Šåè€Œç¡ä¸ä¹…äº†ï¼Œäºæ˜¯ä¹èµ·åºŠä¹°èœï¼Œåœ¨è¶…å¸‚é‡Œçœ‹åˆ°äº†æ–°é²œçš„æ¹¿é¢ï¼Œè¿™æ˜¯ä¸ªæ‚²å‰§çš„å‰æˆâ€¦â€¦ äººç”Ÿä¸åªæœ‰è‹Ÿä¸”çš„å·¥ä½œï¼Œè¿˜æœ‰çœ¼å‰çš„å‡‰æ‹ŒèŠ±ç”Ÿç±³å’Œè¾£å­é¸¡ æ‚è®°è´° ä¸‹åˆçœ‹äº†ä¼šã€Šæœªæ¥ç®€å²ã€‹ï¼Œç¡äº†ä¸€è§‰é†’æ¥å…­ç‚¹å¤šäº†ã€‚æ™šé¥­åƒç‚¹å•¥å‘¢ï¼Ÿå‡‰æ‹ŒèŠ±ç”Ÿç±³æ²¡æœ‰åƒå®Œï¼Œå¹²è„†ä¸‹æ—©ä¸Šä¹°çš„æ¹¿é¢å§ï¼Œæ‚²å‰§å¼€å§‹äº†â€¦â€¦ å†…å¿ƒOSï¼šå¥½æƒ³æ‹¿åˆ€ç äº†è¿™æ¹¿é¢ æ‚è®°å æ™šä¸Šä¸€ä¸ªä¹Ÿä½åœ¨é™„è¿‘çš„å¸ˆå¼Ÿè¦è¿‡æ¥æ‰¾æˆ‘è°ˆå¿ƒï¼Œæˆ‘çš„ç…®é¢å°å¥¶é”…æ¯äº†ï¼Œæˆ‘ä¹Ÿè¦å‡ºå»æ•£æ•£å¿ƒï¼ŒğŸ˜¶ï¼Œå‡ºå»æºœäº†ä¸€åœˆï¼Œæœç„¶æœ‰æ”¶è·ï¼Œè§å›¾ã€‚ ä¸€è¾†åºŸå¼ƒçš„åŠ é•¿æ—è‚¯ï¼Œå­¤ç‹¬çš„å®ˆå€™åœ¨äº”ç¯å¤–çš„é©¬è·¯è¾¹ï¼Œâ€œè¾½â€å­—è½¦ç‰Œéšçº¦å¯è§ã€‚è¿™ä½ä¸œåŒ—å¤§å“¥æ›¾ç»çš„è¾‰ç…Œï¼Œä½ è¯»æ‡‚äº†å—ï¼Ÿ æ‚è®°ç»ˆæœ€åä»¥ã€Šä¹˜é£ç ´æµªã€‹é‡Œçš„ä¸€å¥ç»å…¸å°è¯ä½œä¸ºè¿™ç¯‡æ¯«æ— é€»è¾‘çš„æ‚è®°æ–‡ç« çš„ç»“å°¾å§ã€‚ æˆ‘çš„æ¢¦æƒ³ï¼Œæ­Œèˆå…é‡Œåªå”±æ­Œï¼Œæ¡‘æ‹¿é¦†é‡Œå°±æ´—æ¾¡ï¼ è¿˜æœ‰ä¸€é¦–éå¸¸å¥½å¬çš„æ­Œæ›²æ¨èï¼Œ500 Milesï¼Œæ™šå®‰ï¼Œå¥½æ¢¦~~","categories":[{"name":"é—²èŠ","slug":"é—²èŠ","permalink":"https://geminiguy.github.io/categories/é—²èŠ/"}],"tags":[{"name":"é—²èŠ","slug":"é—²èŠ","permalink":"https://geminiguy.github.io/tags/é—²èŠ/"},{"name":"ç¾é£Ÿ","slug":"ç¾é£Ÿ","permalink":"https://geminiguy.github.io/tags/ç¾é£Ÿ/"}]},{"title":"Ckestrelæ¡†æ¶æµ…æ","slug":"ckestrelæ¡†æ¶æµ…æ","date":"2017-02-11T16:00:00.000Z","updated":"2017-02-12T07:40:58.000Z","comments":true,"path":"2017/02/12/ckestrelæ¡†æ¶æµ…æ/","link":"","permalink":"https://geminiguy.github.io/2017/02/12/ckestrelæ¡†æ¶æµ…æ/","excerpt":"æ¦‚è¿° Kestrelæ˜¯ä¸€ä¸ªåˆ©ç”¨Scalaè¯­è¨€ç¼–å†™çš„è½»é‡çº§æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”±Twitterå›¢é˜Ÿå¼€æºï¼Œå…¶æ”¯æŒä¸‰ç§åè®®ï¼šmemcacheã€thriftã€textã€‚Kestrelå…·æœ‰é«˜æ€§èƒ½ã€ä»£ç è½»é‡çº§ã€æŒä¹…å­˜å‚¨ï¼ˆè®°å½•è¯»å†™æ—¥å¿—åˆ°journalï¼‰ã€å¯é æ€§ï¼ˆæ”¯æŒå¯é è·å–ï¼‰ç­‰ä¼˜ç‚¹ã€‚è€Œæœ¬æ–‡æ‰€è¦è¯´çš„Ckestrelæ˜¯Kestrelçš„C++ç‰ˆæœ¬ï¼Œç”±å›¢é˜Ÿçš„è€å‰è¾ˆæ”¹ç‰ˆè€Œæˆï¼Œé‡‡ç”¨çš„åè®®æ˜¯memcachedæ–‡æœ¬åè®®ã€‚ç”±äºååé‡ã€ç¨³å®šæ€§ã€ä»£ç ç»´æŠ¤æ€§ç­‰ç­‰åŸå› æ»¡è¶³ä¸äº†ä¸šåŠ¡éœ€æ±‚ï¼Œå› æ­¤é€æ­¥ä¼šè¢«Kafkaå–è€Œä»£ä¹‹ã€‚è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘15å¹´åˆšå…¥èŒé‚£ä¼šè°ƒç ”å­¦ä¹ è¿™ä¸ªæ¡†æ¶çš„æºç æ‰€å†™çš„wikiï¼Œç°ç…§æ¬åˆ°æˆ‘çš„åšå®¢ä¸Šé¢ã€‚æœ¬æ–‡å°†å¯¹Ckestrelçš„çº¿ç¨‹æ¨¡å‹åŠçŠ¶æ€æœºã€æŒä¹…åŒ–æ—¥å¿—å’Œå¯é æ€§è¯»å–æœºåˆ¶ç­‰æ–¹é¢åšç›¸å…³åˆ†æã€‚","text":"æ¦‚è¿° Kestrelæ˜¯ä¸€ä¸ªåˆ©ç”¨Scalaè¯­è¨€ç¼–å†™çš„è½»é‡çº§æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”±Twitterå›¢é˜Ÿå¼€æºï¼Œå…¶æ”¯æŒä¸‰ç§åè®®ï¼šmemcacheã€thriftã€textã€‚Kestrelå…·æœ‰é«˜æ€§èƒ½ã€ä»£ç è½»é‡çº§ã€æŒä¹…å­˜å‚¨ï¼ˆè®°å½•è¯»å†™æ—¥å¿—åˆ°journalï¼‰ã€å¯é æ€§ï¼ˆæ”¯æŒå¯é è·å–ï¼‰ç­‰ä¼˜ç‚¹ã€‚è€Œæœ¬æ–‡æ‰€è¦è¯´çš„Ckestrelæ˜¯Kestrelçš„C++ç‰ˆæœ¬ï¼Œç”±å›¢é˜Ÿçš„è€å‰è¾ˆæ”¹ç‰ˆè€Œæˆï¼Œé‡‡ç”¨çš„åè®®æ˜¯memcachedæ–‡æœ¬åè®®ã€‚ç”±äºååé‡ã€ç¨³å®šæ€§ã€ä»£ç ç»´æŠ¤æ€§ç­‰ç­‰åŸå› æ»¡è¶³ä¸äº†ä¸šåŠ¡éœ€æ±‚ï¼Œå› æ­¤é€æ­¥ä¼šè¢«Kafkaå–è€Œä»£ä¹‹ã€‚è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘15å¹´åˆšå…¥èŒé‚£ä¼šè°ƒç ”å­¦ä¹ è¿™ä¸ªæ¡†æ¶çš„æºç æ‰€å†™çš„wikiï¼Œç°ç…§æ¬åˆ°æˆ‘çš„åšå®¢ä¸Šé¢ã€‚æœ¬æ–‡å°†å¯¹Ckestrelçš„çº¿ç¨‹æ¨¡å‹åŠçŠ¶æ€æœºã€æŒä¹…åŒ–æ—¥å¿—å’Œå¯é æ€§è¯»å–æœºåˆ¶ç­‰æ–¹é¢åšç›¸å…³åˆ†æã€‚ CKestrelçº¿ç¨‹æ¨¡å‹åŠçŠ¶æ€æœºçº¿ç¨‹æ¨¡å‹ Ckestrelé‡‡ç”¨äº†memcachedçš„çº¿ç¨‹æ¨¡å‹æ¥å¤„ç†ç½‘ç»œè¿æ¥ï¼Œè€Œmemcachedä½¿ç”¨libeventå®ç°å¼‚æ­¥æœåŠ¡å™¨ï¼Œé‡‡ç”¨ä¸»çº¿ç¨‹å’Œworkerçº¿ç¨‹ï¼Œä¸»çº¿ç¨‹è´Ÿè´£ç›‘å¬ç½‘ç»œè¿æ¥ï¼Œå¹¶ä¸”acceptè¿æ¥ã€‚å½“ç›‘å¬åˆ°è¿æ¥æ—¶ï¼Œacceptè¿æ¥æˆåŠŸåï¼ŒæŠŠç›¸åº”çš„client fdä¸¢ç»™å…¶ä¸­ä¸€ä¸ªworkerçº¿ç¨‹ã€‚workerçº¿ç¨‹æ¥æ”¶ä¸»çº¿ç¨‹ä¸¢è¿‡æ¥çš„client fdï¼ŒåŠ å…¥åˆ°è‡ªå·±çš„epollç›‘å¬é˜Ÿåˆ—ï¼Œè´Ÿè´£å¤„ç†è¯¥è¿æ¥çš„è¯»å†™äº‹ä»¶ã€‚memcachedçš„çº¿ç¨‹æ¨¡å‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š ä¸»çº¿ç¨‹é€šè¿‡evnet_init()ä¸ºè‡ªå·±åˆ†é…ä¸€ä¸ªevent_baseï¼Œç”¨äºç›‘å¬è¿æ¥ï¼Œå³listen fdã€‚ ä¸»çº¿ç¨‹åˆ›å»ºnä¸ªworkerçº¿ç¨‹ï¼ŒåŒæ—¶æ¯ä¸ªworkerçº¿ç¨‹ä¹Ÿåˆ†é…äº†ç‹¬ç«‹çš„event_baseã€‚æ¯ä¸ªworkerçº¿ç¨‹é€šè¿‡ç®¡é“æ–¹å¼ä¸ä¸»çº¿ç¨‹è¿›è¡Œé€šä¿¡ï¼Œè°ƒç”¨pipeå‡½æ•°ï¼Œäº§ç”Ÿä¸¤ä¸ªfdï¼Œä¸€ä¸ªæ˜¯ç®¡é“å†™å…¥fdï¼ˆnotify_send_fdï¼‰ï¼Œä¸€ä¸ªæ˜¯ç®¡é“è¯»å–fdï¼ˆnotify_receive_fdï¼‰ã€‚workerçº¿ç¨‹æŠŠç®¡é“è¯»å–fdï¼ˆnotify_receive_fdï¼‰åŠ åˆ°è‡ªå·±çš„event_baseï¼Œç›‘å¬ç®¡é“è¯»å–fdçš„å¯è¯»äº‹ä»¶ï¼Œå³å½“ä¸»çº¿ç¨‹å¾€æŸä¸ªçº¿ç¨‹çš„ç®¡é“å†™å…¥fdå†™æ•°æ®æ—¶ï¼Œè§¦å‘äº‹ä»¶ã€‚ ä¸»çº¿ç¨‹ç›‘å¬åˆ°æœ‰ä¸€ä¸ªè¿æ¥åˆ°è¾¾æ—¶ï¼Œacceptè¿æ¥ï¼Œäº§ç”Ÿä¸€ä¸ªclient fdï¼Œç„¶åé€‰æ‹©ä¸€ä¸ªworkerçº¿ç¨‹ï¼ŒæŠŠè¿™ä¸ªclient fdåŒ…è£…æˆä¸€ä¸ªCQ_ITEMå¯¹è±¡ï¼ˆå…¶ä¸­ä¸ä»…æœ‰client fdå‚æ•°ï¼Œè¿˜åŒ…æ‹¬init_stateã€event_flagsã€read_buffer_sizeç­‰å‚æ•°ï¼‰ç„¶åå‹åˆ°workerçº¿ç¨‹çš„CQ_ITEMé˜Ÿåˆ—é‡Œé¢å»ï¼ˆæ¯ä¸ªworkerçº¿ç¨‹æœ‰ä¸€ä¸ªCQ_ITEMé˜Ÿåˆ—ï¼‰ï¼ŒåŒæ—¶ä¸»çº¿ç¨‹å¾€é€‰ä¸­çš„workerçº¿ç¨‹çš„ç®¡é“å†™å…¥fdä¸­å†™å…¥ä¸€ä¸ªå­—ç¬¦â€œcâ€ï¼ˆCkestrelä¸­å†™å…¥â€â€ï¼Œç”¨æ¥è§¦å‘workerçº¿ç¨‹ï¼‰ã€‚ æŸä¸ªworkerçº¿ç¨‹ç›‘å¬åˆ°è‡ªå·±çš„ç®¡é“è¯»å–fdå¯è¯»ï¼Œè§¦å‘äº‹ä»¶å¤„ç†å‡½æ•°thread_libevent_processï¼Œä»CQ_ITEMé˜Ÿåˆ—ä¸­å–å‡ºCQ_ITEMå¯¹è±¡ï¼Œè°ƒç”¨conn_newå‡½æ•°æŠŠæ­¤client fdåŠ å…¥åˆ°è‡ªå·±çš„event_baseä¸­ï¼Œä»æ­¤è´Ÿè´£è¯¥è¿æ¥çš„è¯»å†™å·¥ä½œã€‚ çŠ¶æ€æœº ä¸»çº¿ç¨‹å’Œworkerçº¿ç¨‹éƒ½è°ƒç”¨conn_newå‡½æ•°è¿›è¡Œäº‹ä»¶ç›‘å¬ï¼Œæœ‰äº‹ä»¶å‘ç”Ÿæ—¶è°ƒç”¨event_handlerå‡½æ•°ï¼Œæœ€ç»ˆæ‰§è¡Œdriver_machineå‡½æ•°ã€‚çŠ¶æ€æœºdrive_machineå‡½æ•°æ˜¯workerçº¿ç¨‹å¤„ç†ç½‘ç»œè¯·æ±‚ä¸šåŠ¡çš„é€»è¾‘æ ¸å¿ƒã€‚whileå¾ªç¯ä¸­åŒ…å«switch caseï¼Œæ ¹æ®è¿æ¥å¯¹è±¡connçš„å½“å‰è¿æ¥çŠ¶æ€stateè¿›å…¥ä¸åŒçš„caseï¼Œæ¯ä¸ªcaseå¯èƒ½ä¼šæ”¹å˜connå¯¹è±¡çš„è¿æ¥çŠ¶æ€ï¼Œè¿›è€Œè¢«åˆ†å‘åˆ°åˆé€‚çš„caseä¸Šè¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆç”±stop=trueçš„caseåˆ†æ”¯é€€å‡ºwhileå¾ªç¯ã€‚è¯¦ç»†çš„è§£æè¯·å‚è€ƒMemcachedæºç åˆ†æä¹‹è¯·æ±‚å¤„ç†ã€‚ CkestrelæŒä¹…åŒ–æ—¥å¿— Ckestrelæ—¥å¿—æ–‡ä»¶æ˜¯å”¯ä¸€åœ¨ç¡¬ç›˜å­˜å‚¨é˜Ÿåˆ—å†…å®¹çš„æ–¹å¼ï¼Œæ—¥å¿—æ–‡ä»¶ä¸­é¡ºåºè®°å½•æ¯ä¸ªé’ˆå¯¹ç›¸åº”é˜Ÿåˆ—çš„æ·»åŠ å’Œåˆ é™¤æ“ä½œã€‚æ¯ç§æ“ä½œæœ‰å¯¹åº”çš„flagæ¥è®°å½•æ—¥å¿—ç±»å‹ï¼Œflagæ€»å…±æœ‰ä»¥ä¸‹å‡ ç§ï¼šCMD_ADDã€CMD_ADDXã€CMD_ADD_XIDã€CMD_REMOVEã€CMD_REMOVE_TENTATIVEã€CMD_SAVE_XIDã€CMD_UNREMOVEã€CMD_CONFIRM_REMOVEã€‚å…¶ä¸­CMD_ADDXå’ŒCMD_ADDXIDæ“ä½œä¼šåˆ©ç”¨è‡ªå®šä¹‰çš„packå‹ç¼©æ–¹å¼å°†æŸæ¡é˜Ÿåˆ—æ¶ˆæ¯çš„lengthã€xidã€addTimeã€expiryã€dataç­‰ä¿¡æ¯å†™å…¥æ—¥å¿—æ–‡ä»¶ä¸­ã€‚CkestrelæœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œå¯¹æ¯ä¸ªé˜Ÿåˆ—çš„æ—¥å¿—æ–‡ä»¶æ‰§è¡ŒreplayJournalæ“ä½œï¼Œé‡æ–°å»ºç«‹å†…å­˜ä¸­çš„é˜Ÿåˆ—ä»¥ä¾¿å®¢æˆ·ç«¯è®¿é—®ã€‚è¿™ç§æ–¹å¼ä¿è¯äº†å³ä½¿æœåŠ¡å™¨å´©æºƒï¼Œä¹Ÿèƒ½æ ¹æ®æ¯ä¸ªé˜Ÿåˆ—çš„æ—¥å¿—æ–‡ä»¶é‡å»ºå†…å­˜ä¸­çš„é˜Ÿåˆ—æ¶ˆæ¯ã€‚ Ckestrelæ¡†æ¶åœ¨å¯¹journalå¤„ç†ä¸Šä¸ç›®å‰scala 2.4.1ç‰ˆæœ¬ä¸Šæœ‰äº›åŒºåˆ«ã€‚Journal.ccä¸­å®ç°äº†rollæœºåˆ¶å¯¹æ—¥å¿—æ–‡ä»¶è¿›è¡Œå‹ç¼©ã€‚åœ¨PersistentQueue.ccä¸­çš„addæ–¹æ³•ä¸­ï¼š 1234567891011if (keepJournal_ &amp;&amp; !journal_-&gt;inReadBehind()) &#123; if (journal_-&gt;size() &gt; maxJournalSize_ * maxJournalOverflow_ &amp;&amp; queueSize_ &lt; maxJournalSize_) &#123; slog_write(LL_NOTICE, \"Rolling journal file for '%s' (qsize=%d)\", name_.c_str(), queueSize_); deque&lt;QItem *&gt; q = openTransactionQItems(); journal_-&gt;roll(xidCounter_, q, queue_); &#125; if (queueSize_ &gt;= maxMemorySize_) &#123; slog_write(LL_NOTICE, \"Dropping to read-behind for queue '%s' (%lu bytes)\", name_.c_str(), queueSize_); journal_-&gt;startReadBehind(); &#125; &#125; åˆ©ç”¨kestrel.confé…ç½®æ–‡ä»¶è®¾ç½® maxJournalSize = 16Mï¼ŒmaxJournalOverflow = 10ï¼ŒmaxMemorySize = 128Mã€‚åˆå§‹å‘é˜Ÿåˆ—å†™å…¥æ•°æ®æ—¶ï¼Œjournalä¸ä¼šè¿›å…¥ReadBehindæ¨¡å¼ã€‚å½“æ—¥å¿—æ–‡ä»¶å¤§å°å¤§äºmaxJournalSize * maxJournalOverflowå¹¶ä¸”é˜Ÿåˆ—å¤§å°å°äºmaxJournalSizeæ—¶ï¼Œjournalè¿›è¡Œrollæ“ä½œï¼Œé‡æ–°å»ºç«‹æ—¥å¿—æ–‡ä»¶ï¼Œå°†å†…å­˜ä¸­çš„é˜Ÿåˆ—æ¶ˆæ¯addè¿›journal_æ—¥å¿—ä¸­ï¼Œå…¶ä¸­åˆ©ç”¨packç¼–ç æ–¹å¼ï¼Œopcode=CMD_ADDXã€‚åŒæ ·å°†openTransactionQItemsä¸­æœªå®Œæˆçš„äº‹åŠ¡è®°å½•åœ¨å¯¹åº”æ—¥å¿—å½“ä¸­ã€‚ å½“é˜Ÿåˆ—å¤§å°å¤§äºç­‰äºmaxMemorySize_æ—¶ï¼Œå¯åŠ¨ReadBehindæ¨¡å¼ï¼Œåé¢å†™å…¥é˜Ÿåˆ—çš„æ¶ˆæ¯å°†ä¼šå­˜å‚¨åœ¨æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œæ¯å½“ä»å†…å­˜ä¸­removeæ‰æ¶ˆæ¯çš„æ—¶éƒ½ä¼šå°è¯•ä»æ—¥å¿—æ–‡ä»¶ä¸­è¯»å–ç›¸å…³é˜Ÿåˆ—æ¶ˆæ¯å†pushbackåˆ°å†…å­˜é˜Ÿåˆ—ä¸­ï¼Œè¿™ç§çŠ¶æ€ä¸€ç›´æŒç»­åˆ°readerå’Œwriter_æŒ‡é’ˆé‡åˆï¼Œå³åœ¨ReadBehindæ¨¡å¼ä¸‹addè¿›æ—¥å¿—æ–‡ä»¶çš„æ¶ˆæ¯å‡è¢«å¤„ç†å®Œæ¯•ï¼Œé€€å‡ºReadBehindæ¨¡å¼ã€‚ å¦å¤–åœ¨PersistentQueue.ccä¸­removeæ–¹æ³•ä¸­ï¼Œå½“if (queueLength == 0 &amp;&amp; journal -&gt;size() &gt;= maxJournalSize_)æ—¶ï¼Œä¹Ÿä¼šå¯¹æ—¥å¿—æ–‡ä»¶è¿›è¡Œrollæ“ä½œã€‚ å¯é æ€§è¯»å– é»˜è®¤çš„GETå¹¶æ²¡æœ‰åŠ å…¥å¯é æ€§è¯»å–é€‰é¡¹ï¼Œä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯åï¼Œserverç«¯å°±å°†è¯¥æ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œå¦‚æœå®¢æˆ·ç«¯åœ¨å¤„ç†è¿™ä¸ªæ¶ˆæ¯çš„æ—¶å€™å¼‚å¸¸å´©æºƒæˆ–è€…åœ¨æ¥æ”¶æ¶ˆæ¯æ—¶è¿æ¥æ–­å¼€ï¼Œåˆ™è¯¥æ¡é˜Ÿåˆ—æ•°æ®å°±ä¼šæ°¸ä¹…ä¸¢å¤±ï¼Œè€Œä¹‹å‰å‡ºç°çš„RINæ•°æ®ä¸¢å¤±é—®é¢˜åˆ™å‡ºç°åœ¨è¿™é‡Œã€‚è¿™ç§é»˜è®¤çš„æ–¹å¼æ˜¯ä¸å®‰å…¨çš„ï¼Œå› æ­¤Kestrelæä¾›äº†å¯é æ€§è¯»å–æœºåˆ¶ï¼Œåœ¨GETå‘½ä»¤ä¸­åŠ å…¥/openå’Œ/closeé€‰é¡¹ã€‚å®˜æ–¹æ–‡æ¡£å¯¹/openå’Œ/closeçš„æè¿°å¦‚ä¸‹ï¼š /openTentatively remove an item from the queue. The item is returned as usual but is also set aside in case the client disappears before sending a â€œcloseâ€ request. /closeClose any existing open read. å½“åœ¨æ¶ˆè´¹æœºå®¢æˆ·ç«¯GETå‘½ä»¤ä¸­ä½¿ç”¨/openæ—¶ï¼ŒkestrelæœåŠ¡å™¨å°†è¿™ä¸ªæ¶ˆæ¯ä»é˜Ÿåˆ—æš‚æ—¶ç§»é™¤å¹¶æ­£å¸¸å‘é€ç»™æ¶ˆè´¹æœºå®¢æˆ·ç«¯ï¼ŒåŒæ—¶åœ¨openTransactionsè¿™ä¸ªmapå®¹å™¨ä¸­å¤‡ä»½è¯¥é˜Ÿåˆ—æ•°æ®ï¼Œå¦‚æœè¿™æ—¶å€™å®¢æˆ·ç«¯å´©æºƒæˆ–è€…æ–­å¼€è¿æ¥ï¼Œä»openTransactionsä¸­æ ¹æ®xidé”®å–å‡ºè¯¥é˜Ÿåˆ—æ•°æ®ï¼Œé‡æ–°æ”¾å…¥å†…å­˜é˜Ÿåˆ—å¤´éƒ¨ï¼Œå› æ­¤å½“å®¢æˆ·ç«¯é‡æ–°è¿æ¥åå°±å¯ä»¥è·å–åˆ°è¯¥é˜Ÿåˆ—æ¶ˆæ¯ã€‚æ¯ä¸ªè¿æ¥çš„clientåªèƒ½æœ‰ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„å¯é è·å–ï¼Œå†æ¬¡å‘é€å¸¦æœ‰/opené€‰é¡¹çš„GETå‘½ä»¤serverè¿”å›ç©ºï¼ˆåŒä¸€ä¸ªè¿æ¥ç›´æ¥å‘é€GETå‘½ä»¤ä¹Ÿä¼šè¿”å›ç©ºï¼‰ã€‚å½“æ¶ˆè´¹æœºå®¢æˆ·ç«¯æ”¶åˆ°è¯¥é˜Ÿåˆ—æ•°æ®æ—¶ï¼Œå†æ¬¡å‘é€å¸¦/closeé€‰é¡¹çš„GETå‘½ä»¤ï¼Œserverå°†ä¼šconfirmRemoveè¯¥é˜Ÿåˆ—æ•°æ®ï¼Œä»openTransactions_å®¹å™¨ä¸­åˆ é™¤è¿™æ¡é˜Ÿåˆ—æ•°æ®ï¼Œå¹¶åœ¨æ—¥å¿—æ–‡ä»¶ä¸­è®°å½•CMD_CONFIRM_REMOVEã€‚ å…·ä½“åˆ†æå‘é€å®Œå¸¦/opené€‰é¡¹çš„GETå‘½ä»¤åï¼Œæ¶ˆè´¹æœºä¸é˜Ÿåˆ—æœºæœåŠ¡å™¨æ–­å¼€è¿æ¥ï¼Œåˆ™è¿›å…¥Ckestrel.ccä¸­çš„conn_closeå‡½æ•°ï¼Œæ‰§è¡Œqc-&gt;unremoveæ“ä½œã€‚ 12345678static void conn_close(conn *c)&#123; if (c-&gt;xid) &#123; if (qc-&gt;unremove(std::string(c-&gt;xkey, c-&gt;xnkey), c-&gt;xid) == false) &#123; slog_write(LL_WARNING, \"Unremove non-existent transaction\"); &#125; c-&gt;xid = 0; &#125;&#125; æœ€ç»ˆè¿›å…¥PersistentQueue.ccçš„doUnremoveå‡½æ•°ï¼Œåœ¨openTransactions_å®¹å™¨ä¸­æ ¹æ®ä¸Šä¸€æ¡é˜Ÿåˆ—æ¶ˆæ¯çš„xidæ‰¾åˆ°è¯¥itemï¼Œå†pushfrontåˆ°å†…å­˜é˜Ÿåˆ—å¤´éƒ¨ï¼Œåœ¨openTransactionså®¹å™¨ä¸­åˆ é™¤è¯¥é˜Ÿåˆ—æ¶ˆæ¯ã€‚å®¢æˆ·ç«¯é‡æ–°è¿æ¥åˆ°æœåŠ¡å™¨åï¼Œå°±å¯ä»¥ä»æœåŠ¡å™¨å†…å­˜é˜Ÿåˆ—ä¸­å–åˆ°è¯¥æ¡é˜Ÿåˆ—æ¶ˆæ¯ï¼Œè¿™å°±æ˜¯kestrelçš„å¯é è¯»å–æœºåˆ¶çš„å®ç°ã€‚ 123456789101112bool PersistentQueue::doUnremove(int xid) &#123; map&lt;int, QItem*&gt;::iterator it = openTransactions_.find(xid); if (it != openTransactions_.end()) &#123; queueLength_ += 1; queueSize_ += it-&gt;second-&gt;getLength(); queue_.push_front(it-&gt;second); memoryBytes_ += it-&gt;second-&gt;getLength(); openTransactions_.erase(it); return true; &#125; return false;&#125; æ€»ç»“ æœ¬æ–‡ä»Kestrelçš„çº¿ç¨‹æ¨¡å‹ã€çŠ¶æ€æœºã€æŒä¹…åŒ–æ—¥å¿—ã€å¯é æ€§è¯»å–å››ä¸ªæ–¹é¢è¿›è¡Œäº†ç®€å•çš„åˆ†æã€‚è™½ç„¶Kestrelå·²æˆä¸ºå†å²ï¼Œä½†æ˜¯å…¶ä¸­memcachedç½‘ç»œæ¨¡å‹ã€libeventå¼‚æ­¥äº‹ä»¶å¤„ç†åº“ç­‰çŸ¥è¯†ç‚¹è¿˜æ˜¯å¾ˆå€¼å¾—å»å­¦ä¹ å’Œæ€è€ƒçš„ã€‚å¦æ¨èä¸€ç¯‡å¯¹memcachedæºç åˆ†æå†™çš„éå¸¸ä¸é”™çš„ç³»åˆ—åšå®¢ã€‚Memcachedæºç åˆ†æ","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://geminiguy.github.io/categories/æŠ€æœ¯/"}],"tags":[{"name":"Kestrel","slug":"Kestrel","permalink":"https://geminiguy.github.io/tags/Kestrel/"},{"name":"memcache","slug":"memcache","permalink":"https://geminiguy.github.io/tags/memcache/"},{"name":"libevent","slug":"libevent","permalink":"https://geminiguy.github.io/tags/libevent/"},{"name":"åˆ†å¸ƒå¼æ¶ˆæ¯","slug":"åˆ†å¸ƒå¼æ¶ˆæ¯","permalink":"https://geminiguy.github.io/tags/åˆ†å¸ƒå¼æ¶ˆæ¯/"}]},{"title":"æˆ‘çœ¼ä¸­çš„2016å¹´ç”µå½±ä¹‹æœ€","slug":"2016-movie","date":"2017-02-05T03:33:43.000Z","updated":"2017-02-11T09:05:35.000Z","comments":true,"path":"2017/02/05/2016-movie/","link":"","permalink":"https://geminiguy.github.io/2017/02/05/2016-movie/","excerpt":"å‰è¨€ åˆä¹ï¼ŒåŒ—äº¬ï¼Œé˜³å…‰ç¿çƒ‚çš„æ—¥å­ã€‚è€å¤©èµäº†ä¸ªå¥½è„¸è‰²ï¼Œä»¿ä½›åœ¨å¬å”¤æ‘é‡Œçš„ç å†œæ˜å¤©èµ¶ç´§å›æ¥å¼€å·¥ã€‚éš”å£è€ç‹å¹³æ—¶æ¯”è¾ƒå–œæ¬¢èµç‰‡ï¼ˆåˆ«æƒ³æ­ª2333ï¼‰ï¼Œå› æ­¤æƒ³è¶ç€æ–°çš„ä¸€å¹´å¼€å·¥ä¹‹å‰ï¼Œå†æ¥å›é¡¾ä¸€ä¸‹2016å¹´é‚£äº›ç»å…¸çš„ç”µå½±ã€‚ There are a thousand Hamlets in a thousand peopleâ€™s eyes. â€”William Shakespeare è€èè¯´è¿‡ï¼Œä¸€åƒä¸ªäººçœ¼é‡Œå°±æœ‰ä¸€åƒä¸ªå“ˆå§†é›·ç‰¹ã€‚æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±å–œæ¬¢çš„ç”µå½±ç±»å‹ï¼Œè¿™ä¸¤å¹´è±†ç“£ä¸Šä¸ä¹â€œå“ˆéŸ©å…šâ€ã€â€œæ–‡è‰ºè£…é€¼å…šâ€ï¼Œé«˜åˆ†çš„ç”µå½±æœªå¿…ç¬¦åˆå¤§ä¼—çš„å®¡ç¾ï¼Œä¸ä¸€å®šå¥½çœ‹ã€‚å½“ç„¶ä½åˆ†çš„å›½äº§ç”µå½±ï¼Œæ‚¨ä¹Ÿæ— éœ€æ¼ç«ï¼Œå°±åƒæ˜¥èŠ‚æ¡£ä¸Šæ˜ çš„ã€Šè¥¿æ¸¸ä¼å¦–ç¯‡ã€‹ï¼Œç‰¹æ•ˆè¿˜ç®—ä¸é”™ï¼Œç¬‘ç‚¹è¿˜ç®—å‡‘åˆï¼Œè™½ç„¶å‰§æƒ…çƒ‚äº†ç‚¹ï¼Œä½†æ˜¯æ˜¥èŠ‚å¸¦ç€å¤§æœ‹å‹ã€å°æœ‹å‹ä»¬ä¸€èµ·çœ‹çœ‹è¿™ç§æ— å˜å¤´ç”µå½±ï¼Œä¹å‘µä¹å‘µï¼Œä¹Ÿæ˜¯ä¸€ç§ä¸é”™çš„ä½“éªŒï¼Œä½•å†µæ˜Ÿçˆ·æ˜¯ä¸€ä½å¥½çš„æ¼”å‘˜ï¼Œä½†æ˜¯ä»æ¥ä¹Ÿæ²¡æœ‰è¢«æ‰¿è®¤è¿‡æ˜¯ä¸€ä½å¥½çš„å¯¼æ¼”å’Œç¼–å‰§ã€‚çœ‹åˆ°å¾®åšã€è±†ç“£ä¸Šé¢å¯¹è¿™ä¸ªç‰‡çš„å¥½åäº‰å¾—é¢çº¢è€³èµ¤ï¼ŒçœŸæ²¡è¿™ä¸ªå¿…è¦ã€‚ç›®å‰å›½å†…å¯¼æ¼”ä¸æ˜¯æ‹ä¸å‡ºå¥½çš„ç”µå½±ï¼Œè€Œæ˜¯æ„è¯†å½¢æ€æ‰€å†³å®šçš„ï¼Œä¹Ÿä¸èƒ½å…¨æ€¨å…‰è…šæ€»å±€ï¼Œè¿™ä¸ªçŸ¥ä¹å¥½åƒæœ‰è¿‡è®¨è®ºã€‚å†µä¸”ä½ é€ æ¯å¹´ç¾å¸å’Œæ£’å­å›½ä¹Ÿç”Ÿäº§å‡ºå¾ˆå¤šçƒ‚ç‰‡ä¹ˆï¼Ÿå¥½ç‰‡æ¯•ç«Ÿæ˜¯å°‘æ•°ã€‚å¤§å®¶éƒ½è¿™ä¹ˆå¿™ï¼Œé€‰è‡ªå·±å–œæ¬¢çš„ç”µå½±å»æ¶ˆç£¨æ—¶é—´å°±OKå•¦ï¼Œä½•å¿…å’¸åƒèåœæ·¡æ“å¿ƒï¼Œäººå®¶åƒä½ å®¶ä¸€ç²’ç±³å•¦ï¼Ÿå‘µå‘µã€‚å“ï¼Œæœ‰ç‚¹æ‰¯è¿œäº†ï¼Œä¸‹é¢å°±æ¥èŠèŠè€ç‹çœ¼ä¸­çš„2016å¹´ç”µå½±ä¹‹æœ€ã€‚","text":"å‰è¨€ åˆä¹ï¼ŒåŒ—äº¬ï¼Œé˜³å…‰ç¿çƒ‚çš„æ—¥å­ã€‚è€å¤©èµäº†ä¸ªå¥½è„¸è‰²ï¼Œä»¿ä½›åœ¨å¬å”¤æ‘é‡Œçš„ç å†œæ˜å¤©èµ¶ç´§å›æ¥å¼€å·¥ã€‚éš”å£è€ç‹å¹³æ—¶æ¯”è¾ƒå–œæ¬¢èµç‰‡ï¼ˆåˆ«æƒ³æ­ª2333ï¼‰ï¼Œå› æ­¤æƒ³è¶ç€æ–°çš„ä¸€å¹´å¼€å·¥ä¹‹å‰ï¼Œå†æ¥å›é¡¾ä¸€ä¸‹2016å¹´é‚£äº›ç»å…¸çš„ç”µå½±ã€‚ There are a thousand Hamlets in a thousand peopleâ€™s eyes. â€”William Shakespeare è€èè¯´è¿‡ï¼Œä¸€åƒä¸ªäººçœ¼é‡Œå°±æœ‰ä¸€åƒä¸ªå“ˆå§†é›·ç‰¹ã€‚æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±å–œæ¬¢çš„ç”µå½±ç±»å‹ï¼Œè¿™ä¸¤å¹´è±†ç“£ä¸Šä¸ä¹â€œå“ˆéŸ©å…šâ€ã€â€œæ–‡è‰ºè£…é€¼å…šâ€ï¼Œé«˜åˆ†çš„ç”µå½±æœªå¿…ç¬¦åˆå¤§ä¼—çš„å®¡ç¾ï¼Œä¸ä¸€å®šå¥½çœ‹ã€‚å½“ç„¶ä½åˆ†çš„å›½äº§ç”µå½±ï¼Œæ‚¨ä¹Ÿæ— éœ€æ¼ç«ï¼Œå°±åƒæ˜¥èŠ‚æ¡£ä¸Šæ˜ çš„ã€Šè¥¿æ¸¸ä¼å¦–ç¯‡ã€‹ï¼Œç‰¹æ•ˆè¿˜ç®—ä¸é”™ï¼Œç¬‘ç‚¹è¿˜ç®—å‡‘åˆï¼Œè™½ç„¶å‰§æƒ…çƒ‚äº†ç‚¹ï¼Œä½†æ˜¯æ˜¥èŠ‚å¸¦ç€å¤§æœ‹å‹ã€å°æœ‹å‹ä»¬ä¸€èµ·çœ‹çœ‹è¿™ç§æ— å˜å¤´ç”µå½±ï¼Œä¹å‘µä¹å‘µï¼Œä¹Ÿæ˜¯ä¸€ç§ä¸é”™çš„ä½“éªŒï¼Œä½•å†µæ˜Ÿçˆ·æ˜¯ä¸€ä½å¥½çš„æ¼”å‘˜ï¼Œä½†æ˜¯ä»æ¥ä¹Ÿæ²¡æœ‰è¢«æ‰¿è®¤è¿‡æ˜¯ä¸€ä½å¥½çš„å¯¼æ¼”å’Œç¼–å‰§ã€‚çœ‹åˆ°å¾®åšã€è±†ç“£ä¸Šé¢å¯¹è¿™ä¸ªç‰‡çš„å¥½åäº‰å¾—é¢çº¢è€³èµ¤ï¼ŒçœŸæ²¡è¿™ä¸ªå¿…è¦ã€‚ç›®å‰å›½å†…å¯¼æ¼”ä¸æ˜¯æ‹ä¸å‡ºå¥½çš„ç”µå½±ï¼Œè€Œæ˜¯æ„è¯†å½¢æ€æ‰€å†³å®šçš„ï¼Œä¹Ÿä¸èƒ½å…¨æ€¨å…‰è…šæ€»å±€ï¼Œè¿™ä¸ªçŸ¥ä¹å¥½åƒæœ‰è¿‡è®¨è®ºã€‚å†µä¸”ä½ é€ æ¯å¹´ç¾å¸å’Œæ£’å­å›½ä¹Ÿç”Ÿäº§å‡ºå¾ˆå¤šçƒ‚ç‰‡ä¹ˆï¼Ÿå¥½ç‰‡æ¯•ç«Ÿæ˜¯å°‘æ•°ã€‚å¤§å®¶éƒ½è¿™ä¹ˆå¿™ï¼Œé€‰è‡ªå·±å–œæ¬¢çš„ç”µå½±å»æ¶ˆç£¨æ—¶é—´å°±OKå•¦ï¼Œä½•å¿…å’¸åƒèåœæ·¡æ“å¿ƒï¼Œäººå®¶åƒä½ å®¶ä¸€ç²’ç±³å•¦ï¼Ÿå‘µå‘µã€‚å“ï¼Œæœ‰ç‚¹æ‰¯è¿œäº†ï¼Œä¸‹é¢å°±æ¥èŠèŠè€ç‹çœ¼ä¸­çš„2016å¹´ç”µå½±ä¹‹æœ€ã€‚ 2016æœ€å¥½çœ‹çš„å›½äº§çŠ¯ç½ªç‰‡ â€”ã€Šæ¹„å…¬æ²³è¡ŒåŠ¨ã€‹ æ ¹æ®çœŸå®äº‹ä»¶æ”¹ç¼–çš„ç¼‰æ¯’å¤§ç‰‡ï¼Œå¯¹äºä»å°å–œæ¬¢ç©CSçš„æˆ‘æ¥è¯´ï¼Œæ•´éƒ¨ç”µå½±ç‡ƒåˆ°çˆ†ï¼Œè‚¾ä¸Šè…ºç´ çˆ†è¡¨ï¼Œçˆ±å›½æƒ…æ€€çˆ†æ£šã€‚ä¸»æ—‹å¾‹åˆå¦‚ä½•ï¼Œä¸ªäººè‹±é›„ä¸»ä¹‰åˆå¦‚ä½•ï¼Œç¾å¸å¥½è±åä¸ä¹Ÿæ˜¯ç©çš„ä¹Ÿ666ä¹ˆï¼Œä¾‹å¦‚ã€Šè¨é‡Œæœºé•¿ã€‹ï¼Œçœ‹ä¸æƒ¯å›½äº§ç”µå½±ä¸­æœ‰è¿™äº›å…ƒç´ çš„äººçœŸæ˜¯è¢«æƒ¯å‡ºæ¥çš„ã€‚æœ€åå‘ç¼‰æ¯’è­¦å¯Ÿè‡´æ•¬ï¼Œæ„ŸåŠ¨ï¼ 2016å¹´æœ€å¥½çœ‹çš„è’è¯å–œå‰§ â€”ã€Šé©´å¾—æ°´ã€‹ è¿™æ˜¯ä¸€éƒ¨é€éœ²ç€æ‚²å‰§è‰²å½©ï¼Œå¤„å¤„å……æ»¡è®½åˆºçš„å–œå‰§ç”µå½±ã€‚å½±ç‰‡ä¸­çš„æ¯ä¸€ä½äººç‰©çš„æ€§æ ¼éƒ½éå¸¸é²œæ˜ï¼Œä¹Ÿä»£è¡¨äº†é‚£ä¸ªå¹´ä»£ä¸­å›½çš„é˜¶å±‚èƒŒæ™¯ã€‚è¿™éƒ¨ç”µå½±ä¹Ÿå¯ä»¥è§£è¯»ä¸ºå¥³æƒä¸»ä¹‰è€…çš„å‘å–Šï¼Œå¯¹äºæ€§è§£æ”¾çš„æŠ—äº‰ã€‚è±†ç“£ã€çŸ¥ä¹å¯¹äºè¿™éƒ¨ç”µå½±å·²ç»æœ‰éå¸¸å¤šå¥½çš„å½±è¯„äº†ï¼Œå°±ä¸å†ç­é—¨å¼„æ–§äº†ã€‚è¿™éƒ¨ç”µå½±çš„ä¸»é¢˜æ›²ã€Šæˆ‘è¦ä½ ã€‹çœŸæ˜¯å”±çš„å¿ƒç—’ç—’å‘¦ã€‚ä»»ç´ æ±é¥°æ¼”çš„å¼ ä¸€æ›¼æ²¡çš„è¯´ï¼Œå¥½æ¼”å‘˜ä¸çœ‹é¢œå€¼ï¼Œèµï¼ åœ¨çŸ¥ä¹çœ‹åˆ°è¯¥ç‰‡çš„å¯¼æ¼”ç¼–å‰§å‘¨ç”³è°ˆèµ·è¿™éƒ¨å½±ç‰‡ï¼Œè¯´ä»å¼€å§‹åšåˆ°æœ€ååšæˆç»å†äº†7å¹´çš„æ—¶é—´ï¼Œä¸€åº¦å›°éš¾é‡é‡ï¼ŒæœŸé—´å¯¹äºä½œå“çš„è¿½æ±‚è®©ä»–ä»¬ä¹Ÿæ‹’ç»äº†å¾ˆå¤šæŠ•èµ„ï¼Œä¸€ä¸ªé è°±çš„é¡¹ç›®é‡åˆ°äº†ä¸¤ä¸ªä¸é è°±çš„äººï¼Œå“ˆå“ˆï¼Œæœ€ç»ˆå‘¨ç”³å’Œåˆ˜éœ²åšå®ˆä½äº†ä½œå“çš„åº•çº¿ï¼Œå®Œæˆäº†ä¸€éƒ¨è‰ºæœ¯ä¸å•†ä¸šå…¼ä¿®çš„å¥½ç‰‡ï¼Œæœï¼ 2016å¹´æœ€å¥½çœ‹çš„å›½å¤–æˆ˜äº‰ç‰‡ â€”ã€Šæ¯”åˆ©Â·æ—æ©çš„ä¸­åœºæˆ˜äº‹ã€‹ æå®‰å¯¼æ¼”çš„åœ¨è¿™ä¸€éƒ¨ç”µå½±ä¸­è¿ç”¨äº†æ–°çš„æ‹æ‘„æŠ€æœ¯ï¼Œ4K+120å¸§+3Dï¼Œå½“æ—¶åœ¨ç”µå½±é™¢çœ‹è¿™éƒ¨ç‰‡çš„æ—¶å€™åº”è¯¥ä¸æ˜¯120å¸§çš„ï¼Œå› æ­¤å¯¹äº120å¸§åˆ°åº•ç‰›é€¼åœ¨å“ªé‡Œï¼Œé—æ†¾æ²¡èƒ½ä½“ä¼šåˆ°ã€‚è¿™å¼ å‰§ç…§éå¸¸æœ‰æ„æ€ï¼Œè¿™ä½å¤§ç”·å­©å›å®¶äº†ï¼Œä»–æ˜¯ä¸€ä½è‹±é›„ï¼Œæœ‰å®¶äººå’Œä½³äººç›¸ä¼´ï¼Œå›åˆ°æˆ˜åœºï¼Œæ˜¯ä¸€åå£«å…µï¼Œè¦å¿å—ç‚®ç«å’Œæˆ˜å‹çš„ç‰ºç‰²ã€‚è¿™ä½å¤§ç”·å­©å­¤ç‹¬çš„é åœ¨å¢™è¾¹ï¼Œè¿™ä¸€å¤©ä¸­å„ç§ç”»é¢åœ¨è„‘æµ·ä¸­é—ªç°ï¼Œç¬¬ä¸€äººç§°çš„è§†è§’ä¹Ÿæ›´å…·æœ‰å¸¦å…¥æ„Ÿã€‚ä»–çš„æ•…äº‹ï¼Œä½ æ‡‚äº†å—ï¼Ÿæ„¿ä¸–ç•Œå’Œå¹³ï¼ 2016å¹´æœ€å¥½çœ‹çš„åŠ¨ç”»ç‰‡ â€”ã€Šç–¯ç‹‚åŠ¨ç‰©åŸã€‹ é•¿å¤§äº†ï¼Œçœ‹åŠ¨ç”»ç‰‡çš„æ¬¡æ•°å°±å°‘äº†å¾ˆå¤šï¼Œ16å¹´æœ€å¥½çœ‹çš„åŠ¨ç”»ç‰‡è¿˜æ˜¯ä»ä¼—ä¸€ä¸‹ï¼Œç»™äº†è¿™éƒ¨è¿ªå£«å°¼çš„ç‰‡å­ã€‚é‡Œé¢ä¸€äº›æ¢—è¿˜è®°å¿†çŠ¹æ–°ï¼Œæ¯”å¦‚æ ‘æ‡’çš„æ…¢åŠ¨ä½œå¥½æƒ³æ‰“ä»–é¢ï¼Œè¿˜æœ‰æ•™çˆ¶çš„ç»å…¸ç‰‡æ®µCOSï¼Œå“ˆå“ˆï¼Œåƒç»å…¸è‡´æ•¬ï¼Œä¸é”™ã€‚å„ä¸ªæ–¹é¢éƒ½æ˜¯ä¸€éƒ¨ä¸å®¹é”™è¿‡çš„åŠ¨ç”»ç‰‡ã€‚ 2016å¹´æœ€å¥½çœ‹çš„ç¾éš¾ç‰‡ â€”ã€Šé‡œå±±è¡Œã€‹ 2016è¿™ä¸€å¹´å¥½çœ‹çš„éŸ©å›½ç”µå½±å€’ä¸å°‘ï¼Œä¾‹å¦‚ã€Šé‡œå±±è¡Œã€‹ã€Šéš§é“ã€‹ã€Šå°å§ã€‹ç­‰ç­‰ï¼Œè°ˆåˆ°ç¾éš¾ææ€–ç‰‡ï¼Œä¸å¾—ä¸æåˆ°è¿™éƒ¨ã€Šé‡œå±±è¡Œã€‹ï¼Œä¸€éƒ¨ææ€–ç‰‡é‡Œæœ€å¯æ€•çš„æ˜¯ä¸æ˜¯ä¸§å°¸çš„ææ€–ï¼Œè€Œæ˜¯äººæ€§çš„ä¸§å¤±ï¼Œä¾‹å¦‚ä¸Šå±‚å®˜å‘˜å¯¹äºçœŸç›¸çš„æ©ç›–ä»¥åŠè´£ä»»çš„é€ƒé¿ï¼Œé‚£ä½å¤§å”éå¸¸æ¶å¿ƒçš„è‡ªç§å˜´è„¸ç­‰ç­‰ï¼Œå½“ç„¶ï¼Œå½±ç‰‡ä¸­å¹´è½»å°ä¼™ä¸ºäº†é™ªä¼´å¥³å‹å®æ„¿è¢«å’¬æ­»ï¼Œå¤§å”ä¸ºäº†ä¿æŠ¤æ€€å­•çš„å¦»å­å£®çƒˆç‰ºç‰²ï¼ŒçŸ³å®‡ä»æœ€åˆçš„æ¯”è¾ƒè‡ªç§åˆ°æœ€åç‰ºç‰²è‡ªå·±æ‹¯æ•‘ä»–äººä»¥åŠè‡ªå·±å¥³å„¿çš„è¡Œä¸ºï¼Œéƒ½è®©äººæ„ŸåŠ¨ã€‚æœ€åå£«å…µéš¾é“ä¸èƒ½æ”¾ç©ºä¸€æªä¹ˆï¼Œæ™•â€¦..ä¸€éƒ¨åƒµå°¸ç‰‡é€éœ²å‡ºè¿™ä¹ˆå¤šçš„å†…å®¹ï¼Œè¿˜æ˜¯å¾ˆå€¼å¾—å›½äº§ææ€–ç‰‡æ·±æ€çš„ï¼Œè·ç¦»è¿˜æœ‰å¾ˆè¿œã€‚ æœ€åä¸ºå•¥è€æƒ³åˆ°é‚£å¥è¯ï¼Œæ˜çŸ¥å±±æœ‰è™(é‡œ)ï¼Œåå‘è™ï¼ˆé‡œï¼‰å±±è¡Œï¼Œé¢â€¦â€¦ 2016å¹´æœ€å¥½çœ‹çš„æƒ…è‰²ç‰‡ â€”ã€Šå°å§ã€‹ ä½œä¸ºä¸€éƒ¨åŒæ€§ç‰‡æ¥çœ‹ï¼Œå…ˆä¸è¯´é‡Œé¢é€éœ²çš„æ·±å±‚å«ä¹‰ï¼Œå¥³æƒä¸»ä¹‰ã€‚è¿é˜…ç‰‡æ— æ•°çš„éš”å£è€ç‹ï¼Œçœ‹è¿™éƒ¨ç”µå½±çš„æ—¶å€™ï¼Œéƒ½æ— è€»çš„ç¡¬äº†å¥½å‡ æ¬¡ï¼Œï¼ˆæ‚è„¸é€ƒâ€¦â€¦ï¼‰ï¼Œæœ´èµéƒçœŸæ˜¯ä¸ªä¼šè®²æ•…äº‹çš„è‚®è„è€å¤´å­å‘€ï¼Œæ±¡çš„ä¼˜é›…ï¼Œè°çœ‹è°çŸ¥é“ï¼Œå˜¿å˜¿å˜¿ 2016å¹´æœ€å¥½çœ‹çš„åŠ±å¿—ç‰‡ â€”ã€Šå«åº•è¾£å¦¹ã€‹ è¿™ç‰‡å…¶å®15å¹´å°±å·²ç»åœ¨å²›å›½ä¸Šæ˜ ï¼Œ16å¹´4æœˆä»½æ‰åœ¨å¤§é™†ä¸Šæ˜ ï¼Œè®²è¿°äº†ä¸€ä½æ¼‚äº®çš„å°å§å§ä¸æ­£å¹²ï¼Œåœ¨ç­é‡Œå€’æ•°å«åº•ï¼Œä¸­é—´è¢«åªç”°è€æ¹¿è°ƒæ•™ï¼Œå‘ç°è‡ªå·±è¿˜è›®æœ‰æ½œåŠ›çš„å‘¢ï¼Œå¸¦ç€å¥¹å¦ˆçš„äº²æƒ…å…‰ç¯ï¼Œé—ºèœœåŒå­¦å‹æƒ…åŠ æŒï¼Œç»åœ°é€†è¢­ï¼Œè€ƒå–äº†åº†åº”å¤§å­¦æ–‡å­¦ç³»ï¼ˆè¿˜å¥½ä¸è€ƒæ•°å­¦å•Šâ€¦..ï¼‰ï¼Œä»¥å¤§å¤šæ•°äººçš„åŠªåŠ›ç¨‹åº¦ä¹‹ä½ï¼Œæ ¹æœ¬è½®ä¸åˆ°å»æ‹¼å¤©èµ‹ï¼Œå—¯å“¼ï¼Œå®å±é¸¡æ±¤åŠ±å¿—ç”µå½±ä½³ä½œã€‚å…¶å®è¿˜æœ‰ä¸€éƒ¨ã€Šé£é¹°è‰¾è¿ªã€‹ä¹Ÿæ˜¯16å¹´çš„åŠ±å¿—å¥½ç‰‡ï¼Œä½†æ˜¯è°è®©çˆ±å­¦ä¹ çš„å°å§å§è¿™ä¹ˆæ¼‚é…¿æ¸…çº¯å‘¢ï¼Œå°±é€‰ä½ äº†~~ 2016å¹´æœ€å¥½çœ‹çš„ç§‘å¹»ç‰‡ â€”ã€Šå¥‡å¼‚åšå£«ã€‹ è¿™ä¸€å¹´çš„ç§‘å¹»å¤§ä½œä¸å°‘ï¼Œä¾‹å¦‚ã€Šå¥‡å¼‚åšå£«ã€‹ã€ã€ŠXæˆ˜è­¦:å¤©å¯ã€‹ã€ã€Šé­”å…½ã€‹ã€ã€Šç¾å›½é˜Ÿé•¿3ã€‹ã€ã€Šæ­»ä¾ã€‹ç­‰ç­‰ã€‚è§†è§‰ç‰¹æ•ˆæ²¡å¾—è¯´ï¼Œå¤§çˆ±å·ç¦ï¼Œæ¼«å¨åŠ¨æ¼«æ”¹ç¼–çš„ç”µå½±ï¼Œå…¶ä¸­å¾ˆå¤šå½©è›‹å…³è”ä¹Ÿæ˜¯çœ‹äº†å½±è¯„æ‰äº†è§£ï¼Œçº¯å•†ä¸šå¤§ç‰‡ï¼Œä¸çŸ¥é“å†è¯´äº›å•¥äº†ï¼Œè€å¸æœºå¼€è½¦ä¸è¦ç©æ‰‹æœºå•Š2333ã€‚æ¬¢è¿doctoråŠ å…¥å¤ä»‡è€…è”ç›Ÿï¼Œä¸çŸ¥é“ä¼šä¸ä¼šå‡ºç°åœ¨ç¬¬ä¸‰éƒ¨ç³»åˆ—ä½œå“å½“ä¸­å‘¢ï¼Ÿ 2016å¹´æœ€å¥½çœ‹çš„å†å²ä¼ è®°ç‰‡ â€”ã€Šæ–¯è¯ºç™»ã€‹ è¯´èµ·å†å²ä¼ è®°ç‰‡ï¼Œé«˜åˆ†ç‰‡éå¸¸å¤šï¼Œä½†æ˜¯è¿™ä¸€å¹´è¿™ç§é¢˜æçš„ç‰‡å­çœ‹çš„å°‘ä¸”æˆ‘ä¹Ÿæ¯”è¾ƒä¿—ï¼Œå°±é€‰äº†ä¸€éƒ¨æœ€è´´è¿‘ç”Ÿæ´»çš„ã€‚æ£±é•œäº‹ä»¶ç¡®å®éå¸¸éœ‡æƒŠï¼Œå…¶å®ç¾å¸ç›‘å¬é‚®ä»¶ã€ç”µè¯ã€èŠå¤©è®°å½•é‚£ä¸€å¥—ï¼Œå…¶ä»–å›½å®¶æœªå¿…ä¸å­˜åœ¨ã€‚è¿™éƒ¨ç”µå½±æ˜¯æŠŠâ€œçˆ±å›½è€…â€ä¸å…¬æ°‘éšç§æƒçš„å¯¹ç«‹é¢æ”¾å¤§äº†ï¼Œäº‹ç‰©å‡æœ‰ä¸¤é¢æ€§ï¼Œè¿˜æ˜¯å€¼å¾—æ·±æ€çš„ã€‚å½±ç‰‡ä¸­æ–¯è¯ºç™»çš„æ‰®æ¼”è€…æ¼”æŠ€å‡ºä¼—ï¼ŒITå±Œä¸æ°”è´¨ä¸geekæ°”è´¨å®Œç¾ã€‚æœ€åä¹Ÿæé†’å¤§å®¶åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­å¤šæ³¨æ„è‡ªå·±çš„éšç§å®‰å…¨ã€‚ 2016å¹´æœ€å¥½çœ‹çš„çˆ±æƒ…ç‰‡ â€”ã€Šä½ çš„åå­—ã€‹ 2016çˆ±æƒ…ç‰‡çœ‹çš„æ˜¯æœ€å°‘çš„ï¼Œæ„Ÿæƒ…ä¸ç®—é¡ºåˆ©ï¼ŒæœŸå¾…2017å¹´ä½ çš„åå­—å‡ºç°å§ï¼Œå“ˆå“ˆï¼Œï¼ˆé€ƒ æ€»ç»“ç¥æ„¿2017å¹´æ¶Œç°å‡ºæ›´å¤šçš„ä¼˜ç§€å›½äº§ç‰‡ï¼Œå•é å–æƒ…æ€€ï¼Œæ¶ˆè´¹ç²‰ä¸çš„ipç”µå½±å°‘èµšç‚¹é’±å§ï¼ˆè™½ç„¶ä¸å¤ªå¯èƒ½ï¼Œå‘µå‘µï¼‰ã€‚Whateverï¼Œæ˜å¤©å¼€å·¥å¤§å‰ï¼","categories":[{"name":"ç”µå½±","slug":"ç”µå½±","permalink":"https://geminiguy.github.io/categories/ç”µå½±/"}],"tags":[{"name":"ç”µå½±","slug":"ç”µå½±","permalink":"https://geminiguy.github.io/tags/ç”µå½±/"},{"name":"2016","slug":"2016","permalink":"https://geminiguy.github.io/tags/2016/"}]},{"title":"Kafka Controller","slug":"Kafka-Controller","date":"2017-01-12T16:00:00.000Z","updated":"2017-01-17T09:33:27.000Z","comments":true,"path":"2017/01/13/Kafka-Controller/","link":"","permalink":"https://geminiguy.github.io/2017/01/13/Kafka-Controller/","excerpt":"å‰è¨€ç›®å‰ç½‘ä¸Šé’ˆå¯¹Kafka Controllerçš„åˆ†ææ–‡ç« ä¸ç®—å°‘ï¼Œä½†æ˜¯å¤§å¤šæ¯”è¾ƒæ•£ä¹±ï¼Œä¸å¤Ÿç³»ç»Ÿï¼Œå› æ­¤è¶ç€è¿™æ¬¡éƒ¨é—¨åˆ†äº«Kafkaçš„æœºä¼šï¼Œå°†ä¸€äº›çŸ¥è¯†ç‚¹è¿›è¡Œäº†æ¢³ç†æ€»ç»“ï¼Œå­¦ä¹ è¿‡ç¨‹ä¸­å‚è€ƒäº†ä¸€äº›åŸç†æ€§çš„åˆ†ææ–‡ç« å’Œ0.10ç‰ˆæœ¬çš„æºç ã€‚æœ¬æ–‡åŸ‹äº†ä¸€äº›ç»†èŠ‚å‘ï¼Œå¾…æœ‰æ—¶é—´å†å›æ¥è¡¥å…¨å§ã€‚å¯¹äºKafkaçš„ç ”ç©¶æ°´å¹³æœ‰é™ï¼Œå¦‚æœæ–‡ç« ä¸­å‡ºç°é”™è¯¯ï¼Œè¿˜æœ›åœ¨è¯„è®ºåŒºäº¤æµæŒ‡æ­£ï¼Œè°¢è°¢ã€‚ä¸‹é¢æˆ‘ä»¬é¦–å…ˆä»åŸºç¡€æ¦‚å¿µå¼€å§‹è®²èµ·ã€‚","text":"å‰è¨€ç›®å‰ç½‘ä¸Šé’ˆå¯¹Kafka Controllerçš„åˆ†ææ–‡ç« ä¸ç®—å°‘ï¼Œä½†æ˜¯å¤§å¤šæ¯”è¾ƒæ•£ä¹±ï¼Œä¸å¤Ÿç³»ç»Ÿï¼Œå› æ­¤è¶ç€è¿™æ¬¡éƒ¨é—¨åˆ†äº«Kafkaçš„æœºä¼šï¼Œå°†ä¸€äº›çŸ¥è¯†ç‚¹è¿›è¡Œäº†æ¢³ç†æ€»ç»“ï¼Œå­¦ä¹ è¿‡ç¨‹ä¸­å‚è€ƒäº†ä¸€äº›åŸç†æ€§çš„åˆ†ææ–‡ç« å’Œ0.10ç‰ˆæœ¬çš„æºç ã€‚æœ¬æ–‡åŸ‹äº†ä¸€äº›ç»†èŠ‚å‘ï¼Œå¾…æœ‰æ—¶é—´å†å›æ¥è¡¥å…¨å§ã€‚å¯¹äºKafkaçš„ç ”ç©¶æ°´å¹³æœ‰é™ï¼Œå¦‚æœæ–‡ç« ä¸­å‡ºç°é”™è¯¯ï¼Œè¿˜æœ›åœ¨è¯„è®ºåŒºäº¤æµæŒ‡æ­£ï¼Œè°¢è°¢ã€‚ä¸‹é¢æˆ‘ä»¬é¦–å…ˆä»åŸºç¡€æ¦‚å¿µå¼€å§‹è®²èµ·ã€‚ åŸºç¡€æ¦‚å¿µ ä»€ä¹ˆæ˜¯Controllerï¼š ä»Kafkaé›†ç¾¤ä¸­é€‰å–ä¸€ä¸ªbrokerä½œä¸ºcontrollerï¼Œè´Ÿè´£ç®¡ç†topicåˆ†åŒºå’Œå‰¯æœ¬çš„çŠ¶æ€çš„å˜åŒ–ï¼Œä»¥åŠæ‰§è¡Œé‡åˆ†é…åˆ†åŒºä¹‹ç±»çš„ç®¡ç†ä»»åŠ¡ã€‚ Replicationæ€»å…±ç»å†äº†ä¸‰ä¸ªç‰ˆæœ¬çš„è¿­ä»£ï¼Œå…¶ä¼˜ç‚¹å¦‚ä¸‹ï¼š è§£å†³äº†Zkçš„split-brainé—®é¢˜ï¼Œåˆ†åŒºçŠ¶æ€çš„ä¸€è‡´æ€§å¾—åˆ°ä¿éšœ æ›´å°‘çš„ZKç›‘å¬å™¨ï¼Œå‡è½»äº†Zkè´Ÿè½½ä»¥åŠherd effecté—®é¢˜ Leaderçš„å˜åŒ–é’ˆå¯¹Zkçš„è¯»å†™å¯ä»¥æ‰¹é‡æ“ä½œï¼Œå‡å°‘failoverè¿‡ç¨‹ä¸­çš„å»¶è¿Ÿ Controllerå°†çŠ¶æ€çš„æ”¹å˜ç›´æ¥é€šè¿‡RPCçš„æ–¹å¼é€šçŸ¥ç›¸åº”brokerï¼Œç›¸æ¯”ZKé˜Ÿåˆ—æ–¹å¼æ›´é«˜æ•ˆ åè¯è§£é‡Š AR å½“å‰å·²åˆ†é…çš„å‰¯æœ¬åˆ—è¡¨ RAR é‡åˆ†é…è¿‡çš„å‰¯æœ¬åˆ—è¡¨ ORA é‡åˆ†é…ä¹‹å‰çš„å‰¯æœ¬åˆ—è¡¨ åˆ†åŒºLeader ç»™å®šåˆ†åŒºè´Ÿè´£å®¢æˆ·ç«¯è¯»å†™çš„ç»“ç‚¹ ISR â€œin-syncâ€ replicasï¼Œèƒ½å¤Ÿä¸Leaderä¿æŒåŒæ­¥çš„å‰¯æœ¬é›†åˆï¼ˆLeaderä¹Ÿåœ¨ISRä¸­ï¼‰ å’Œcontrollerç›¸å…³çš„zookeeperè·¯å¾„è¯´æ˜ /controllerï¼šç»“ç‚¹å­˜æ”¾å½“å‰Controllerä¿¡æ¯ /brokers/ids/[brokerId]ï¼šå­˜æ”¾é›†ç¾¤brokerä¿¡æ¯ï¼ŒåŒ…æ‹¬ipã€ç«¯å£ã€jmxä¿¡æ¯ /brokers/topicsï¼šå­ç›®å½•ä¸ºtopicåˆ—è¡¨ /brokers/topics/[topic]ï¼šå­˜æ”¾å¯¹åº”topicçš„å„ä¸ªåˆ†åŒºAR /brokers/topics/[topic]/partitions/[partitionId]/stateï¼šç»“ç‚¹å­˜æ”¾å½“å‰topicå„ä¸ªåˆ†åŒºçš„Leaderã€ISRã€controller_epochã€leader_epochç­‰ä¿¡æ¯ã€‚ /adminä¸´æ—¶ç»“ç‚¹ï¼Œåªæœ‰ç›¸å…³æ“ä½œæ—¶æ‰ä¼šå­˜åœ¨ /admin/delete_topicsï¼š è¦åˆ é™¤çš„ä¸€äº›topic /admin/reassign_partitionsï¼šæŒ‡å¯¼é‡æ–°åˆ†é…ARçš„è·¯å¾„ï¼Œé€šè¿‡å‘½ä»¤ä¿®æ”¹ARæ—¶ä¼šå†™å…¥åˆ°è¿™ä¸ªè·¯å¾„ä¸‹ /admin/preferred_replica_electionï¼šåˆ†åŒºéœ€è¦é‡æ–°é€‰ä¸¾ç¬¬ä¸€ä¸ªreplicaä½œä¸ºleaderï¼Œå³preferred replicaã€‚èµ·åˆ°è‡ªåŠ¨å¹³è¡¡Leaderåˆ†é…çš„ä½œç”¨ï¼Œä½¿ç”¨è‡ªå¸¦å·¥å…·æˆ–è€…auto.leader.rebalance.enable=trueå‡å¯ LeaderAndIsrRequest,UpdateMetadataRequest,StopReplicaRequestLeaderAndIsrRequestè¯·æ±‚åŠå“åº”123456789101112131415161718192021222324/*** controllerIdï¼šcontrolleræ‰€åœ¨çš„brokerId* controllerEpochï¼šcontrolleré€‰ä¸¾ç‰ˆæœ¬å·* partitionStatesï¼šMap[(topic, partitionId), PartitionState]* liveLeadersï¼šä¼ å…¥å‚æ•°åˆ†åŒºleaderæ‰€åœ¨çš„brokeré›†åˆ*/public LeaderAndIsrRequest(int controllerId, int controllerEpoch, Map&lt;TopicPartition, PartitionState&gt; partitionStates,Set&lt;Node&gt; liveLeaders) &#123;...&#125;/*** controllerEpochï¼šcontrolleré€‰ä¸¾ç‰ˆæœ¬å·* leaderï¼šåˆ†åŒºleaderæ‰€åœ¨çš„broker Id* leaderEpochï¼šåˆ†åŒºleaderé€‰ä¸¾ç‰ˆæœ¬å·* isrï¼šå½“å‰ISRåˆ—è¡¨* zkVersionï¼šåˆ†åŒºåœ¨zookeeperä¸Šçš„çŠ¶æ€ä¿¡æ¯ï¼Œç”¨ä½œç«æ€æ›´æ–°* replicasï¼šåˆ†åŒºå‰¯æœ¬åˆ—è¡¨*/public PartitionState(int controllerEpoch, int leader, int leaderEpoch, List&lt;Integer&gt; isr, int zkVersion, Set&lt;Integer&gt; replicas) &#123; this.controllerEpoch = controllerEpoch; this.leader = leader; this.leaderEpoch = leaderEpoch; this.isr = isr; this.zkVersion = zkVersion; this.replicas = replicas;&#125; è¯·æ±‚å“åº”æµç¨‹ï¼šmakeLeadersã€makeFollowerså…·ä½“é€»è¾‘ç•™å‘å¾…å¡« UpdateMetadataRequestè¯·æ±‚åŠå“åº”12345678/*** å¯ä»¥çœ‹åˆ°æ­¤æ„é€ å‡½æ•°å’ŒLeaderAndIsrRequestè¯·æ±‚ç±»æ„é€ å‡½æ•°å‚æ•°åŸºæœ¬ä¸€è‡´* liveBrokersï¼šå­˜æ´»çš„brokeré›†åˆ*/public UpdateMetadataRequest(int version, int controllerId, int controllerEpoch, Map&lt;TopicPartition, PartitionState&gt; partitionStates, Set&lt;Broker&gt; liveBrokers)è¯·æ±‚å“åº”ï¼šæ¯ä¸ªbrokeréƒ½ç»´æŠ¤äº†ç›¸åŒçš„ç¼“å­˜ï¼Œæ›´æ–°MetadataCacheå®ä¾‹ä¸­çš„chaceå­—æ®µå’ŒaliveBrokerå­—æ®µåˆ†åˆ«ä¸ºtopicå¯¹åº”çš„åˆ†åŒºçŠ¶æ€ä¿¡æ¯ä»¥åŠå½“å‰å¯ç”¨çš„brokeråˆ—è¡¨ StopReplicaRequestè¯·æ±‚åŠå“åº”1234public StopReplicaRequest(int controllerId, int controllerEpoch, boolean deletePartitions, Set&lt;TopicPartition&gt; partitions)è¯·æ±‚å“åº”ï¼š1. ReplicaManagerä¼šç§»é™¤replicaæ‰€åœ¨çš„partitionçš„Fetcherï¼Œå³ä¸å†å‘è¯¥partitionçš„leaderæ‹‰å–æ–°çš„æ•°æ®2. å†æ ¹æ®deletePartitionså†³å®šæ˜¯å¦åˆ é™¤è¯¥replicaå¯¹åº”çš„topic partitionæ—¥å¿— PartitionçŠ¶æ€æœº PartitionStateå››ç§åˆ†åŒºçŠ¶æ€å¦‚ä¸‹ï¼š NonExistentPartitionï¼šè¯¥åˆ†åŒºè¦ä¹ˆæ²¡æœ‰è¢«åˆ›å»ºè¿‡æˆ–æ›¾ç»è¢«åˆ›å»ºè¿‡ä½†åé¢åˆ é™¤äº† NewPartitionï¼šåˆ†åŒºåˆ›å»ºä¹‹åå·²ç»åˆ†é…äº†å‰¯æœ¬ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰é€‰ä¸¾å‡ºLeaderå’ŒISR OnlinePartitionï¼šåˆ†åŒºLeaderä¸€æ—¦è¢«é€‰ä¸¾å‡ºæ¥ï¼Œå°±å¤„åœ¨è¯¥çŠ¶æ€ OfflinePartitionï¼šå¦‚æœleaderé€‰ä¸¾å‡ºæ¥åï¼Œleader brokerå®•æœºäº†ï¼Œé‚£ä¹ˆè¯¥åˆ†åŒºå°±å¤„äºOfflinePartitionçŠ¶æ€ åˆ†åŒºçŠ¶æ€è½¬æ¢å›¾é’ˆå¯¹OnlinePartition,OfflinePartition â€“&gt; OnlinePartitionè€Œè¨€ï¼Œæœ‰å››ç§Leaderé€‰ä¸¾å™¨ç­–ç•¥å¦‚ä¸‹: OfflinePartitionLeaderSelector If at least one broker from the isr is alive, it picks a broker from the live isr as the new leader and the live isr as the new isr. Else, if unclean leader election for the topic is disabled, it throws a NoReplicaOnlineException. Else, it picks some alive broker from the assigned replica list as the new leader and the new isr. If no broker in the assigned replica list is alive, it throws a NoReplicaOnlineException Replicas to receive LeaderAndIsr request = live assigned replicasï¼ŒOnce the leader is successfully registered in zookeeper, it updates the allLeaders cache ReassignedPartitionLeaderSelector New leader = a live in-sync reassigned replicaNew isr = current isrReplicas to receive LeaderAndIsr request = reassigned replicas PreferredReplicaPartitionLeaderSelector New leader = preferred (first assigned) replica (if in isr and alive)New isr = current isrReplicas to receive LeaderAndIsr request = assigned replicas ControlledShutdownLeaderSelector New leader = replica in isr thatâ€™s not being shutdownNew isr = current isr - shutdown replicaReplicas to receive LeaderAndIsr request = live assigned replicas ReplicaçŠ¶æ€æœº ReplicaStateå‰¯æœ¬çŠ¶æ€å¦‚ä¸‹ï¼š NewReplicaï¼šå½“åˆ›å»ºäº†topicæˆ–è€…é‡åˆ†é…åˆ†åŒºæ—¶Controllerä¼šåˆ›å»ºæ–°çš„å‰¯æœ¬ï¼Œå°±å¤„åœ¨è¿™ä¸ªçŠ¶æ€ï¼Œæ­¤çŠ¶æ€ä¸­çš„å‰¯æœ¬åªèƒ½æ¥æ”¶â€œæˆä¸ºfollowerâ€çš„çŠ¶æ€å˜æ›´è¯·æ±‚ï¼Œå¯ç”±NonExistentReplicaè½¬æ¢è€Œæ¥ OnlineReplicaï¼šä¸€æ—¦å¯åŠ¨äº†ä¸€ä¸ªå‰¯æœ¬ä»¥åŠè¯¥åˆ†åŒºARå‰¯æœ¬é›†åˆä¸­çš„ä¸€éƒ¨åˆ†ï¼Œé‚£ä¹ˆå°±å°†è®¾ç½®è¯¥å‰¯æœ¬çŠ¶æ€ä¸ºOnlineReplicaã€‚åœ¨æ­¤çŠ¶æ€ä¸­çš„å‰¯æœ¬å¯ä»¥æ¥æ”¶â€æˆä¸ºleaderâ€æˆ–â€æˆä¸ºfollowerâ€çš„çŠ¶æ€å˜æ›´è¯·æ±‚ã€‚å¯ç”±NewRelicaã€OnlineReplicaæˆ–OfflineReplicaçŠ¶æ€è½¬æ¢è€Œæ¥ OfflineReplicaï¼šå¦‚æœä¸€ä¸ªå‰¯æœ¬æŒ‚æ‰(ä¿å­˜è¯¥å‰¯æœ¬çš„brokerå®•æœº)å°†è¢«ç½®äºOfflineReplicaçŠ¶æ€ï¼Œå¯ç”±NewReplicaæˆ–OnlineReplicaçŠ¶æ€è½¬æ¢è€Œæ¥ ReplicaDeletionStartedï¼šå¼€å¯å‰¯æœ¬åˆ é™¤æ“ä½œæ—¶ä¼šå°†å‰¯æœ¬çŠ¶æ€ç½®äºReplicaDeletionStartedçŠ¶æ€ï¼Œå¯ç”±OfflineReplicaçŠ¶æ€è½¬æ¢è€Œæ¥ ReplicaDeletionSuccessfulï¼šå¦‚æœå‰¯æœ¬åˆ é™¤è¯·æ±‚æˆåŠŸï¼Œè¿”å›çš„å“åº”æ²¡æœ‰é”™è¯¯çš„è¯ï¼Œè¯¥å‰¯æœ¬ä¼šè¢«ç½®äºReplicaDeletionSuccessfulçŠ¶æ€ï¼Œå¯ç”±ReplicaDeletionStartedçŠ¶æ€è½¬æ¢è€Œæ¥ ReplicaDeletionIneligibleï¼šå¦‚æœå‰¯æœ¬åˆ é™¤å¤±è´¥ï¼Œå°†è¢«ç½®äºReplicaDeletionIneligibleçŠ¶æ€ï¼Œå¯ç”±ReplicaDeletionStartedçŠ¶æ€è½¬æ¢è€Œæ¥ NonExistentReplicaï¼šå¦‚æœå‰¯æœ¬è¢«æˆåŠŸåˆ é™¤å°†è¢«ç½®äºNonExistentReplicaçŠ¶æ€ï¼Œå¯ç”±ReplicaDeletionSuccessfulçŠ¶æ€è½¬æ¢è€Œæ¥ å‰¯æœ¬çŠ¶æ€è½¬æ¢å›¾ ä¸¾ä¾‹åˆ†æåˆ›å»ºtopic å‘½ä»¤è¡Œé€»è¾‘ 12345bin/kafka-topics.sh --zookeeper XXX:12181 --create --topic fanstop_messagecore --partitions 2 --replication-factor 3a.ç¡®å®šåˆ†åŒºå‰¯æœ¬çš„åˆ†é…æ–¹æ¡ˆ0 --&gt; [2,1,3]1 --&gt; [3,2,4]b.åˆ›å»ºZkç»“ç‚¹ï¼Œå°†åˆ†é…æ–¹æ¡ˆå†™åˆ° /brokers/topics/fanstop_messagecore ç»“ç‚¹ä¸‹ Controlleråå°é€»è¾‘ Controllerå¯åŠ¨æ—¶,åˆ†åŒºçŠ¶æ€æœºPartitionStateMachine.registerListeners()ä¼šæ³¨å†Œä¸€äº›ç›‘å¬å™¨ï¼Œå½“ç”¨å‘½ä»¤è¡Œæ–°å¢åŠ äº†/brokers/topics/fanstop_messagecoreç»“ç‚¹åï¼Œå°±ä¼šè§¦å‘ç›‘å¬å™¨TopicChangeListenerçš„handleChildChangeæ–¹æ³•ï¼Œé€»è¾‘å¦‚ä¸‹ï¼š è·å–/brokers/topicsè·¯å¾„ä¸‹é›†åˆï¼Œä¸å½“å‰controllerä¸­ä¿å­˜çš„topicé›†åˆæ¯”è¾ƒï¼Œæ‰¾å‡ºæ–°å¢topicé›†åˆï¼Œæ¯”å¦‚fanstop_messagecoreï¼ˆæ–°å¢oråˆ é™¤ï¼‰ æ›´æ–°controllerçš„topicç¼“å­˜åˆ—è¡¨ ä»/brokers/topics/fanstop_messagecoreç»“ç‚¹å–å‡ºè¿™ä¸ªtopicæ‰€æœ‰åˆ†åŒºçš„åˆ†é…æ–¹æ¡ˆï¼Œæ›´æ–°controllerå¯¹åº”çš„ç¼“å­˜ä¿¡æ¯ è°ƒç”¨KafkaController.onNewTopicCreationæ–¹æ³• onNewTopicCreation 123456def onNewTopicCreation(topics: Set[String], newPartitions: Set[TopicAndPartition]) &#123; info(\"New topic creation callback for %s\".format(newPartitions.mkString(\",\"))) // subscribe to partition changes topics.foreach(topic =&gt; partitionStateMachine.registerPartitionChangeListener(topic)) onNewPartitionCreation(newPartitions)&#125; ä¸ºæ¯ä¸€ä¸ªtopicæ³¨å†Œ/brokers/topics/[topic]/ä¸‹çš„åˆ†åŒºå˜æ›´ç›‘å¬å™¨PartitionModificationsListenerï¼Œæœ¬æ¬¡ä»…æ³¨å†Œä½†ä¸ä¼šè§¦å‘ è°ƒç”¨onNewPartitionCreationæ–¹æ³•åˆ›å»ºåˆ†åŒº onNewPartitionCreation 1234567def onNewPartitionCreation(newPartitions: Set[TopicAndPartition]) &#123; info(\"New partition creation callback for %s\".format(newPartitions.mkString(\",\"))) partitionStateMachine.handleStateChanges(newPartitions, NewPartition) replicaStateMachine.handleStateChanges(controllerContext.replicasForPartition(newPartitions), NewReplica) partitionStateMachine.handleStateChanges(newPartitions, OnlinePartition, offlinePartitionSelector) replicaStateMachine.handleStateChanges(controllerContext.replicasForPartition(newPartitions), OnlineReplica)&#125; åˆ›å»ºæ–°å¢åˆ†åŒºå¯¹è±¡ï¼Œåˆ†åŒºçŠ¶æ€æœºå°†æ–°åˆ›å»ºåˆ†åŒºè½¬å˜ä¸ºNewPartitionçŠ¶æ€ ä»Controllerç¼“å­˜ä¸­å–å‡ºæ–°å¢åˆ†åŒºçš„å‰¯æœ¬åˆ†é…æ–¹æ¡ˆï¼Œé’ˆå¯¹æ¯ä¸€ä¸ªreplicaè¿›è¡ŒNonExistentReplicaâ€“&gt; NewReplicaçŠ¶æ€è½¬æ¢ åˆ†åŒºçŠ¶æ€ NewPartitionâ€“&gt;OnlinePartitionï¼Œè°ƒç”¨initializeLeaderAndIsrForPartition(topicAndPartition)ä¸ºæ–°åˆ†åŒºåˆå§‹åŒ–leaderå’Œisrè·¯å¾„ã€‚ä¸»è¦ç­–ç•¥å°±æ˜¯è®©ARä¸­ç¬¬ä¸€ä¸ªreplicaä½œä¸ºleaderï¼Œæ‰€æœ‰å¯ç”¨çš„replicaä½œä¸ºISRï¼Œå°†leaderã€ISRã€leaderepochã€controllerepochã€zkversionç­‰ä¿¡æ¯å†™å…¥Zk stateèŠ‚ç‚¹ï¼ŒControllerContextæ›´æ–°ç›¸åº”topicåˆ†åŒºçš„leaderå’ŒISRç¼“å­˜ã€‚ä¹‹åå°±æ˜¯å‘é€LeaderAndIsrRequestç»™æ¯ä¸ªreplicaå’ŒUpdateMetadataRequestè¯·æ±‚ç»™æ¯ä¸ªå¯ç”¨çš„broker è®¾ç½®å‰¯æœ¬çŠ¶æ€æœºçŠ¶æ€NewReplicaâ€”&gt;OnlineReplicaï¼Œå°†å½“å‰çš„replicaåŠ å…¥åˆ°controllerContext ARç¼“å­˜ä¸­ã€‚å®Œäº‹â€¦â€¦ Broker Failureä¸‹é¢æ¥åˆ†æä¸€ä¸‹æŸå°brokerå®•æœºçš„æƒ…å†µã€‚ brokerå®•æœºåï¼Œzkä¼šè¯è¶…æ—¶ï¼Œ/brokers/idså¯¹åº”ç»“ç‚¹è¢«åˆ é™¤ï¼Œè§¦å‘BrokerChangeListener.handleChildChangeï¼Œæ¥ç€åˆè°ƒç”¨controller.onBrokerFailureæ–¹æ³•ï¼Œ å¯¹Leaderå‰¯æœ¬åœ¨deadBrokerä¸Šçš„åˆ†åŒºï¼ˆåŒæ—¶è¦æ’é™¤topicåœ¨åˆ é™¤çš„çŠ¶æ€ï¼‰è§¦å‘OfflinePartitionçŠ¶æ€è½¬æ¢ è¿™ä¸€æ­¥å°±æ˜¯ä¸ºå¤„äºOfflinePartitionçŠ¶æ€çš„åˆ†åŒºè§¦å‘OnlinePartitionçŠ¶æ€è½¬æ¢ï¼Œokï¼Œè¿˜è®°å¾—ä¸Šé¢æåˆ°çš„OfflinePartitionLeaderSelectoré€‰ä¸¾å™¨å§ï¼Œè¿™å›å°±ç”¨å®ƒæ¥è¿›è¡ŒLeaderé€‰ä¸¾ã€ISRé‡åˆ†é…ï¼Œä»¥åŠé€‰å‡ºæ¥æ”¶LeaderAndIsrè¯·æ±‚çš„replicaã€‚æ›´æ–°ä¸€ä¸‹Zk stateç»“ç‚¹çš„leaderå’ŒISRç›¸å…³ä¿¡æ¯ï¼Œæ›´æ–°controllerContextçš„leaderç¼“å­˜ï¼Œç»™ç›¸åº”brokerå‘é€LeaderAndIsrRequestè¯·æ±‚ï¼Œé¡ºå¸¦å‘é€UpdateMetadataRequestè¯·æ±‚ï¼Œè¿™äº›åŠ¨ä½œéƒ½æ˜¯åœ¨electLeaderForPartitionå‡½æ•°ä¸­å®Œæˆ æ‰¾å‡ºdeadBrokerä¸Šçš„æ‰€æœ‰å‰¯æœ¬ï¼Œå¹¶ä¸”è¦è¿‡æ»¤æ‰ä¸€äº›topicsæ­£åœ¨æ‰§è¡Œåˆ é™¤æ“ä½œçš„replicaï¼Œå‰¯æœ¬çŠ¶æ€æœºæ‰§è¡ŒOfflineRelicaçŠ¶æ€è½¬æ¢ï¼Œè¿‡ç¨‹ä¸å†èµ˜è¿° checkå‡ºæ­£åœ¨æ‰§è¡Œtopicåˆ é™¤æœŸé—´çš„replicaï¼Œå°†è¿™äº›replicaç½®ä¸ºReplicaDeletionIneligibleï¼Œè¿™äº›replicaåœ¨broker downçš„æ—¶å€™æ˜¯ä¸èƒ½è¢«åˆ é™¤çš„ã€‚ åˆ†åŒºå‰¯æœ¬é‡æ–°åˆ†é…ç­–ç•¥Kafkaæä¾›äº†åˆ†åŒºé‡æ–°åˆ†é…çš„å·¥å…·ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œéšç€è´Ÿè½½çš„å¢å¤§ï¼Œå¯èƒ½éœ€è¦ç»™Kafkaé›†ç¾¤æ‰©å®¹ï¼Œä½†æ˜¯å¯¹äºå·²å­˜åœ¨çš„topicï¼Œå¹¶ä¸ä¼šè‡ªåŠ¨å°†åˆ†åŒºçš„å‰¯æœ¬è¿ç§»åˆ°æ–°çš„Brokerä¸Šï¼Œå°±å¯ä»¥ç”¨åˆ°è¿™ä¸ªå·¥å…·ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç”¨è¿™ä¸ªå·¥å…·æ¥è°ƒæ•´åˆ†åŒºçš„ARæ•°é‡ï¼Œä¸‹é¢å°±æ¥è¯´ä¸€ä¸‹Partitionæ–¹æ¡ˆé‡æ–°åˆ†é…çš„æƒ…å†µï¼Œä¹Ÿæ¶‰åŠControlleréå¸¸é‡è¦çš„ä¸€ä¸ªæ–¹æ³•ï¼šonPartitionReassignmentã€‚å½“ç”¨å‘½ä»¤è¡Œå‘èµ·åˆ†åŒºé‡åˆ†é…æ“ä½œæ—¶ï¼Œå®ƒä¼šåœ¨/admin/reassign_partitionsè·¯å¾„ä¸‹åˆ›å»ºèŠ‚ç‚¹ï¼Œè¿›è€Œè§¦å‘PartitionsReassignedListenerç›‘å¬å™¨ï¼Œæ‰§è¡ŒhandleDataChangeå‡½æ•°ï¼Œè¿‡æ»¤æ‰æ­£åœ¨æ‰§è¡Œé‡åˆ†é…çš„å‰¯æœ¬çš„åˆ†åŒºï¼Œæ¥ç€åˆ¤æ–­å®ƒä»¬çš„topicæ˜¯å¦æ­£åœ¨è¿›è¡Œåˆ é™¤ï¼Œæ„é€ ä¸€ä¸ªReassignedPartitionsContextä¼ é€’ç»™controller.initiateReassignReplicasForTopicPartitionä¸ºç»™å®štopicåˆ†åŒºé‡æ–°åˆ†é…å‰¯æœ¬ï¼Œè¿™ä¸ªå‡½æ•°çš„é€»è¾‘çœ‹äº†ä¸‹æºç ï¼ŒåŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š å–å‡ºcontrollerContexté’ˆå¯¹è¿™ä¸ªåˆ†åŒºçš„ARç¼“å­˜ï¼Œå½“å‰ARå’ŒRARé›†åˆå®Œå…¨ä¸€æ ·çš„çš„è¯ï¼ŒæŠ›å¼‚å¸¸ï¼Œä¸ç”¨é‡åˆ†é…äº† å¦åˆ™ï¼Œåˆ¤æ–­ä¸€ä¸‹RARä¸­æ˜¯å¦å­˜åœ¨ä¸å¯ç”¨çš„å‰¯æœ¬ï¼Œå¦‚æœå­˜åœ¨replica not aliveï¼ŒæŠ›å¼‚å¸¸ï¼Œæ­¤æ¬¡é‡åˆ†é…æ“ä½œæ— æ³•è¿›è¡Œ å¦‚æœRARä¸­å‡å¯ç”¨ï¼Œæ³¨å†ŒZk stateç»“ç‚¹çš„listenï¼Œç›‘å¬ISRå˜åŒ–ï¼Œmarkä¸€ä¸‹è¯¥topicä¸èƒ½è¢«åˆ é™¤ã€‚ æœ€åä¸€æ­¥è°ƒç”¨æœ€é‡è¦çš„å‡½æ•°onPartitionReassignmentå¼€å§‹é‡æ–°åˆ†é…åˆ†åŒºçš„å‰¯æœ¬ onPartitionReassignmentè¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ä»¥æºç ä¸­çš„ä¾‹å­æ¥è¯´æ˜æ•´ä¸ªæµç¨‹:OAR = {1,2,3}RAR = (4,5,6) AR(Zk) leader/isr(Zk) transition {1,2,3} 1/{1,2,3} (initial state) {1,2,3,4,5,6} 1/{1,2,3} (step 2) {1,2,3,4,5,6} 1/{1,2,3,4,5,6} (step 4) {1,2,3,4,5,6} 4/{1,2,3,4,5,6} (step 7) {1,2,3,4,5,6} 4/{4,5,6} (step 8) {4,5,6} 4/{4,5,6} (step 10) æ€»ç»“æœ¬æ–‡åªä¸¾äº†ä¸‰ä¸ªç»å…¸çš„ä¾‹å­ï¼Œåé¢å†æ…¢æ…¢æ‰©å……ç”¨åˆ°Controllerçš„å®ä¾‹åˆ†æå§ã€‚å¯¹äºä¹‹å‰è¿Scalaè¯­æ³•éƒ½æ²¡æ¥è§¦è¿‡çš„è€ç‹æ¥è¯´ï¼Œæ•´ä¸ªè°ƒç ”å­¦ä¹ è¿‡ç¨‹çœŸå¯è°“æŠ˜ç£¨è›‹ç–¼é¢ï¼ŒæŠ€æœ¯æ— æ­¢å¢ƒï¼Œå…±å‹‰å§ã€‚Howeverï¼Œè¿˜æ˜¯å¸Œæœ›æœ¬æ–‡èƒ½å¯¹è¯»è€…æœ‰æ‰€å¸®åŠ©ã€‚ å‚è€ƒæ–‡çŒ® å®˜æ–¹wikiï¼šKafka Controller Internals æ¨èKafkaç›¸å…³åšå®¢ Kafka Controlleræºç åˆ†æ","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://geminiguy.github.io/categories/æŠ€æœ¯/"}],"tags":[{"name":"Kafka Controller","slug":"Kafka-Controller","permalink":"https://geminiguy.github.io/tags/Kafka-Controller/"},{"name":"æºç åˆ†æ","slug":"æºç åˆ†æ","permalink":"https://geminiguy.github.io/tags/æºç åˆ†æ/"},{"name":"Kafka","slug":"Kafka","permalink":"https://geminiguy.github.io/tags/Kafka/"}]},{"title":"Hello World","slug":"index","date":"2016-12-31T16:00:00.000Z","updated":"2017-01-14T09:27:00.000Z","comments":true,"path":"2017/01/01/index/","link":"","permalink":"https://geminiguy.github.io/2017/01/01/index/","excerpt":"","text":"Hello worldï¼Œéš”å£è€ç‹æ–°çš„ä¸€å¹´åšå®¢å¼€å¼ ä¸ªäººæ¯”è¾ƒæ‡’ï¼Œå¹³æ—¶çŸ¥è¯†ç‚¹ä¹Ÿåªæ˜¯éšæ‰‹è®°å½•åœ¨å°è±¡ç¬”è®°å¸Œæœ›è¿™ä¸€å¹´èƒ½å¤šå†™ä¸€äº›æŠ€æœ¯æ–‡ç« å§Whateverï¼Œæ–°å¹´å¿«ä¹Psï¼šHexoçš„ç¯å¢ƒé…ç½®çœŸæ˜¯å¥½å¤šå‘å•Šï¼Œè¿˜æ˜¯æ¯”è¾ƒå–œæ¬¢NexTè¿™ä¸ªä¸»é¢˜","categories":[{"name":"é—²èŠ","slug":"é—²èŠ","permalink":"https://geminiguy.github.io/categories/é—²èŠ/"}],"tags":[{"name":"é—²èŠ","slug":"é—²èŠ","permalink":"https://geminiguy.github.io/tags/é—²èŠ/"}]}]}