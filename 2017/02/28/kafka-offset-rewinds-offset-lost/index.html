<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Kafka,æ•°æ®ä¸€è‡´æ€§,é«˜å¯ç”¨æ€§," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="åºè¨€ã€€ã€€Kafka Offset Rewindsæ˜¯ä»€ä¹ˆï¼ŸKafkaæ•°æ®ä¸¢å¤±åˆç”±å“ªäº›åŸå› é€ æˆï¼Ÿå¦‚æœè¯»è€…å¯¹è¿™äº›é—®é¢˜äº†å¦‚æŒ‡æŒï¼Œé‚£ä¹ˆå¤§ç¥èµ°å¥½ä¸é€ï¼Œè¿™ç¯‡æ–‡ç« å¯ä»¥ä¸ç”¨æµªè´¹æ—¶é—´äº†ã€‚æœ¬æ–‡é¦–å…ˆå¯¹æˆ‘ä»¬ä¸šåŠ¡ç”Ÿäº§ç¯å¢ƒä¸­é‡åˆ°çš„offset rewindsé—®é¢˜åšä¸€ä¸ªè¯¦å°½åˆ†æï¼Œæ¥ç€å¼•å‡ºkafkaæ•°æ®ä¸¢å¤±çš„å„ç§æƒ…å†µã€‚OKï¼ŒåºŸè¯å°‘è¯´ï¼Œæˆ³æˆ‘ï¼ŒğŸ”½é˜…è¯»å…¨æ–‡ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="Kafka Offsetå€’å›å’Œæ•°æ®ä¸¢å¤±ï¼Ÿ">
<meta property="og:url" content="https://geminiguy.github.io/2017/02/28/kafka-offset-rewinds-offset-lost/index.html">
<meta property="og:site_name" content="éš”å£è€ç‹çš„Blog">
<meta property="og:description" content="åºè¨€ã€€ã€€Kafka Offset Rewindsæ˜¯ä»€ä¹ˆï¼ŸKafkaæ•°æ®ä¸¢å¤±åˆç”±å“ªäº›åŸå› é€ æˆï¼Ÿå¦‚æœè¯»è€…å¯¹è¿™äº›é—®é¢˜äº†å¦‚æŒ‡æŒï¼Œé‚£ä¹ˆå¤§ç¥èµ°å¥½ä¸é€ï¼Œè¿™ç¯‡æ–‡ç« å¯ä»¥ä¸ç”¨æµªè´¹æ—¶é—´äº†ã€‚æœ¬æ–‡é¦–å…ˆå¯¹æˆ‘ä»¬ä¸šåŠ¡ç”Ÿäº§ç¯å¢ƒä¸­é‡åˆ°çš„offset rewindsé—®é¢˜åšä¸€ä¸ªè¯¦å°½åˆ†æï¼Œæ¥ç€å¼•å‡ºkafkaæ•°æ®ä¸¢å¤±çš„å„ç§æƒ…å†µã€‚OKï¼ŒåºŸè¯å°‘è¯´ï¼Œæˆ³æˆ‘ï¼ŒğŸ”½é˜…è¯»å…¨æ–‡ã€‚">
<meta property="og:image" content="http://ol7f62vwl.bkt.clouddn.com/rewind-offset.png">
<meta property="og:image" content="http://ol7f62vwl.bkt.clouddn.com/broker-2-controller.png">
<meta property="og:image" content="http://ol7f62vwl.bkt.clouddn.com/broker-1-controller.png">
<meta property="og:image" content="http://ol7f62vwl.bkt.clouddn.com/broker-2-expire.png">
<meta property="og:image" content="http://ol7f62vwl.bkt.clouddn.com/server-2.png">
<meta property="og:image" content="http://ol7f62vwl.bkt.clouddn.com/unclean.png">
<meta property="og:updated_time" content="2017-03-05T02:14:15.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kafka Offsetå€’å›å’Œæ•°æ®ä¸¢å¤±ï¼Ÿ">
<meta name="twitter:description" content="åºè¨€ã€€ã€€Kafka Offset Rewindsæ˜¯ä»€ä¹ˆï¼ŸKafkaæ•°æ®ä¸¢å¤±åˆç”±å“ªäº›åŸå› é€ æˆï¼Ÿå¦‚æœè¯»è€…å¯¹è¿™äº›é—®é¢˜äº†å¦‚æŒ‡æŒï¼Œé‚£ä¹ˆå¤§ç¥èµ°å¥½ä¸é€ï¼Œè¿™ç¯‡æ–‡ç« å¯ä»¥ä¸ç”¨æµªè´¹æ—¶é—´äº†ã€‚æœ¬æ–‡é¦–å…ˆå¯¹æˆ‘ä»¬ä¸šåŠ¡ç”Ÿäº§ç¯å¢ƒä¸­é‡åˆ°çš„offset rewindsé—®é¢˜åšä¸€ä¸ªè¯¦å°½åˆ†æï¼Œæ¥ç€å¼•å‡ºkafkaæ•°æ®ä¸¢å¤±çš„å„ç§æƒ…å†µã€‚OKï¼ŒåºŸè¯å°‘è¯´ï¼Œæˆ³æˆ‘ï¼ŒğŸ”½é˜…è¯»å…¨æ–‡ã€‚">
<meta name="twitter:image" content="http://ol7f62vwl.bkt.clouddn.com/rewind-offset.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 6371023569551361000,
      author: 'åšä¸»'
    }
  };
</script>

  <title> Kafka Offsetå€’å›å’Œæ•°æ®ä¸¢å¤±ï¼Ÿ | éš”å£è€ç‹çš„Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=60402835";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">éš”å£è€ç‹çš„Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Kafka Offsetå€’å›å’Œæ•°æ®ä¸¢å¤±ï¼Ÿ
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2017-02-28T00:00:00+08:00" content="2017-02-28">
              2017-02-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/æŠ€æœ¯/" itemprop="url" rel="index">
                    <span itemprop="name">æŠ€æœ¯</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/02/28/kafka-offset-rewinds-offset-lost/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/28/kafka-offset-rewinds-offset-lost/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h1><p>ã€€ã€€Kafka Offset Rewindsæ˜¯ä»€ä¹ˆï¼ŸKafkaæ•°æ®ä¸¢å¤±åˆç”±å“ªäº›åŸå› é€ æˆï¼Ÿå¦‚æœè¯»è€…å¯¹è¿™äº›é—®é¢˜äº†å¦‚æŒ‡æŒï¼Œé‚£ä¹ˆå¤§ç¥èµ°å¥½ä¸é€ï¼Œè¿™ç¯‡æ–‡ç« å¯ä»¥ä¸ç”¨æµªè´¹æ—¶é—´äº†ã€‚æœ¬æ–‡é¦–å…ˆå¯¹æˆ‘ä»¬ä¸šåŠ¡ç”Ÿäº§ç¯å¢ƒä¸­é‡åˆ°çš„offset rewindsé—®é¢˜åšä¸€ä¸ªè¯¦å°½åˆ†æï¼Œæ¥ç€å¼•å‡ºkafkaæ•°æ®ä¸¢å¤±çš„å„ç§æƒ…å†µã€‚OKï¼ŒåºŸè¯å°‘è¯´ï¼Œæˆ³æˆ‘ï¼ŒğŸ”½é˜…è¯»å…¨æ–‡ã€‚<br><a id="more"></a></p>
<h1 id="Kafka-Offset-Rewinds"><a href="#Kafka-Offset-Rewinds" class="headerlink" title="Kafka Offset Rewinds"></a>Kafka Offset Rewinds</h1><h2 id="Offset-Rewindsæ¦‚å¿µ"><a href="#Offset-Rewindsæ¦‚å¿µ" class="headerlink" title="Offset Rewindsæ¦‚å¿µ"></a>Offset Rewindsæ¦‚å¿µ</h2><p>ã€€ã€€Kafkaçš„æŸä¸ªgroupçš„æŸä¸ªconsumerè¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰ç”±Coordinatoråˆ†é…äº†æ¶ˆè´¹ä»»åŠ¡å»fetchæŸä¸ªåˆ†åŒºçš„æ•°æ®åï¼Œä¼šæ ¹æ®è¯¥groupæäº¤çš„offsetå»å†³å®šä»åˆ†åŒºçš„å“ªä¸ªåç§»ä½ç½®å»å¼€å§‹æ¶ˆè´¹ã€‚å½“ç„¶ï¼Œå¦‚æœè¿™æ˜¯ä¸€ä¸ªæ–°çš„groupè¿˜æ²¡æœ‰æäº¤è¿‡offsetï¼Œæˆ–è€…ä¹‹å‰æäº¤çš„offsetå‘ç”Ÿäº†è¶Šç•Œé”™è¯¯ï¼Œæ¯”å¦‚offsetå¯¹åº”çš„ä½ç§»çš„æ•°æ®ç”±äºå·²è¿‡æœŸæ—¥å¿—å·²è¢«åˆ é™¤ï¼Œå†æ¯”å¦‚ï¼Œä½ æƒ³pollçš„é‚£ä¸ªä½ç§»å¤„çš„æ•°æ®è¿˜æ²¡æœ‰å†™å…¥leaderï¼ˆwtfï¼Ÿè¿™æ˜¯æœ‰å¯èƒ½çš„ï¼Œæ­£æ˜¯æœ¬æ–‡ç°è±¡æ‰€è®¨è®ºçš„ï¼Œåˆ«æ€¥ï¼Œå¾€ä¸‹çœ‹ï¼‰ã€‚æ­¤æ—¶å°±ä¼šæ ¹æ®ä½ çš„consumerå®ä¾‹åˆå§‹åŒ–æ—¶è®¾ç½®çš„auto.offset.resetå‚æ•°å†³å®šå¤„ç†æ–¹å¼ã€‚è®¾ç½®ä¸ºearliestï¼Œä»leaderèƒ½è·å–çš„æœ€å°çš„ä½ç§»åç§»é‡å¼€å§‹æ‹‰å–æ•°æ®ï¼Œé€ æˆå¤§é‡é‡å¤æ¶ˆè´¹ã€‚lateståˆ™è‡ªåŠ¨åˆå§‹åŒ–ä¸ºæœ€æ–°çš„ä½ç§»åç§»é‡å¤„pollæ•°æ®è¿›è¡Œæ¶ˆè´¹ï¼Œå­˜åœ¨ä¸¢å¤±æ•°æ®çš„å¯èƒ½æ€§ã€‚è€Œæœ¬æ–‡çš„offset rewindsä¸»è¦æ˜¯æŒ‡offsetä½ç§»åç§»é‡å€’å›åˆ°æœ€æ—©çš„ä¸€æ¡æ•°æ®å¼€å§‹æ¶ˆè´¹è¿™ç§ç°è±¡ã€‚</p>
<h2 id="ç°è±¡reviewåŠæ’æŸ¥"><a href="#ç°è±¡reviewåŠæ’æŸ¥" class="headerlink" title="ç°è±¡reviewåŠæ’æŸ¥"></a>ç°è±¡reviewåŠæ’æŸ¥</h2><p>ã€€ã€€å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªé—®é¢˜æ˜¯å¦‚ä½•è¢«ç›‘æ§åˆ°çš„ï¼Œæˆ‘ä»¬çš„åŒå­¦å¯¹äºwb_userdata_ffk03æ–°å¼€äº†ä¸ªgroupï¼Œå°†æ¶ˆè´¹åˆ°çš„æ•°æ®å†™å…¥influxdbå¹¶åŸºäºGrafanaè¿›è¡Œäº†ç›‘æ§ï¼Œå¯ä»¥çœ‹åˆ°æŸå¤©æ™šä¸Š19ï¼š00å·¦å³çš„æ—¶å€™æ¶ˆè´¹çš„æ•°æ®é‡æ¯”ä¹‹å‰çªå¢äº†äº”å€ï¼ŒåŒæ—¶Burrowä¹Ÿå‘å‡ºäº†lagå †ç§¯æŠ¥è­¦ï¼ŒæŸ¥çœ‹Kafka-managerä¹Ÿå¯ä»¥çœ‹åˆ°å‡ ä¸ªå †ç§¯çš„åˆ†åŒºåœ¨åŒä¸€ä¸ªbrokerä¸Šé¢ã€‚ç§ç§ç°è±¡è¯´æ˜äº†æˆ‘ä»¬çš„groupå‘ç”Ÿäº†offset rewindsï¼Œä»å¤´å¼€å§‹æ¶ˆè´¹ã€‚<br><img src="http://ol7f62vwl.bkt.clouddn.com/rewind-offset.png" alt="kafka-monitor"><br>ã€€ã€€ä»¥topicï¼šwb_userdata_ffk03ï¼Œpartitionï¼š19ï¼ŒARï¼š[2,3]ï¼ŒISRï¼š[2,3], leaderï¼š2ä¸ºä¾‹ã€‚å»ç›¸åº”çš„brokerä¸Šé¢è¿›è¡Œæ—¥å¿—æ’æŸ¥ï¼Œçœ‹çœ‹7ç‚¹å·¦å³åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚broker 2çš„controller.logæ˜¾ç¤ºå¦‚ä¸‹ï¼š<br><img src="http://ol7f62vwl.bkt.clouddn.com/broker-2-controller.png" alt="2-25 broker-1"><br>ã€€ã€€broker 1çš„controller.log<br><img src="http://ol7f62vwl.bkt.clouddn.com/broker-1-controller.png" alt=""><br>ã€€ã€€ä»ä¸Šé¢ä¸¤å¼ æˆªå›¾å¯ä»¥çœ‹åˆ°broker 2åœ¨18:58:54æ—¶é‡æ–°åŠ å…¥äº†ï¼Œè¯´æ˜ä¹‹å‰è¯¥ç»“ç‚¹è¢«åˆ è¿‡é¢ï¼Œé‚£ç¬¬äºŒå¼ æˆªå›¾ä¸ºä½•æ²¡æœ‰æ‰“å°deleted brokerså‘¢ï¼Œåªæœ‰ä¸€ä¸ªåŸå› ï¼Œbroker 2æ­¤æ—¶è¿˜æ˜¯controllerï¼Œå›§å•Šã€‚ä¸è¿‡æ²¡æœ‰å…³ç³»ï¼Œä¸‹é¢è¿™å¼ æˆªå›¾broker 2 controllerçš„æ—¥å¿—æ˜ç¡®éªŒè¯äº†æ­¤æ—¶broker 2 session timeoutï¼Œbroker failureå–½ã€‚<br><img src="http://ol7f62vwl.bkt.clouddn.com/broker-2-expire.png" alt=""><br>ã€€ã€€åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬èƒ½å¤Ÿç¡®ä¿¡è¿™ä¸ªæ—¶é—´ç‚¹ï¼Œè¿™ä¸ªåˆ†åŒºçš„leader 2ç¡®å®failureäº†ï¼Œä½†æ˜¯ä¸ºä½•ä¼šå‡ºç°offset rewindså‘¢ï¼Ÿæ‚²å‰§ç»§ç»­ä¸Šæ¼”â€¦â€¦ è¿™å¼ æˆªå›¾æ˜¯broker 2çš„server.logï¼Œå¯ä»¥çœ‹åˆ°è¿™æ—¶å€™replica 3ä»ISRä¸­è¢«è¸¢å‡ºå»äº†ï¼Œæ­¤æ—¶ISRä¸­å°±åªæœ‰2äº†ï¼Œæ¥ç€leader 2åˆå‘ç”Ÿäº†å®•æœºğŸ˜¶ã€‚<br><img src="http://ol7f62vwl.bkt.clouddn.com/server-2.png" alt=""></p>
<p>ã€€ã€€å…³äºè¿™ä¸ªISRçŠ¶æ€çš„å˜åŒ–æˆ‘å†å¤šè¯´ä¸€ç‚¹ã€‚ä»€ä¹ˆæƒ…å†µä¸‹ä¸€ä¸ªreplicaä¼šè¢«ä»ISRä¸­è¸¢å‡ºå»å‘¢ï¼Ÿå…ˆå¤§ä½“çœ‹ä¸€ä¸‹maybeShrinkIsrå’ŒgetOutOfSyncReplicasä¸¤ä¸ªå‡½æ•°ã€‚</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">maybeShrinkIsr</span></span>(replicaMaxLagTimeMs: <span class="type">Long</span>) &#123;</div><div class="line">      <span class="keyword">val</span> leaderHWIncremented = inWriteLock(leaderIsrUpdateLock) &#123;</div><div class="line">      leaderReplicaIfLocal() <span class="keyword">match</span> &#123;</div><div class="line">      <span class="keyword">case</span> <span class="type">Some</span>(leaderReplica) =&gt;</div><div class="line">          <span class="keyword">val</span> outOfSyncReplicas = getOutOfSyncReplicas(leaderReplica, replicaMaxLagTimeMs)</div><div class="line">          <span class="keyword">if</span>(outOfSyncReplicas.size &gt; <span class="number">0</span>) &#123;</div><div class="line">              <span class="keyword">val</span> newInSyncReplicas = inSyncReplicas -- outOfSyncReplicas</div><div class="line">              assert(newInSyncReplicas.size &gt; <span class="number">0</span>)</div><div class="line">              info(<span class="string">"Shrinking ISR for partition [%s,%d] from %s to %s"</span>.format(topic, partitionId,inSyncReplicas.map(_.brokerId).mkString(<span class="string">","</span>),newInSyncReplicas.map(_.brokerId).mkString(<span class="string">","</span>)))</div><div class="line">              <span class="comment">// update ISR in zk and in cache</span></div><div class="line">              updateIsr(newInSyncReplicas)</div><div class="line">              <span class="comment">// we may need to increment high watermark since ISR could be down to 1</span></div><div class="line"></div><div class="line">              replicaManager.isrShrinkRate.mark()</div><div class="line">              maybeIncrementLeaderHW(leaderReplica)</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="literal">false</span></div><div class="line">        &#125;</div><div class="line">      <span class="keyword">case</span> <span class="type">None</span> =&gt; <span class="literal">false</span> <span class="comment">// do nothing if no longer leader</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">      <span class="comment">// some delayed operations may be unblocked after HW changed</span></div><div class="line">      <span class="keyword">if</span> (leaderHWIncremented)</div><div class="line">          tryCompleteDelayedRequests()</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getOutOfSyncReplicas</span></span>(leaderReplica: <span class="type">Replica</span>, maxLagMs: <span class="type">Long</span>): <span class="type">Set</span>[<span class="type">Replica</span>] = &#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line">   * there are two cases that will be handled here -</div><div class="line">   * 1. Stuck followers: If the leo of the replica hasn't been updated for maxLagMs ms,</div><div class="line">   *                     the follower is stuck and should be removed from the ISR</div><div class="line">   * 2. Slow followers: If the replica has not read up to the leo within the last maxLagMs ms,</div><div class="line">   *                    then the follower is lagging and should be removed from the ISR</div><div class="line">   * Both these cases are handled by checking the lastCaughtUpTimeMs which represents</div><div class="line">   * the last time when the replica was fully caught up. If either of the above conditions</div><div class="line">   * is violated, that replica is considered to be out of sync</div><div class="line">   *</div><div class="line">   **/</div><div class="line">  <span class="keyword">val</span> leaderLogEndOffset = leaderReplica.logEndOffset</div><div class="line">  <span class="keyword">val</span> candidateReplicas = inSyncReplicas - leaderReplica</div><div class="line"></div><div class="line">  <span class="keyword">val</span> laggingReplicas = candidateReplicas.filter(r =&gt; (time.milliseconds - r.lastCaughtUpTimeMs) &gt; maxLagMs)</div><div class="line">  <span class="keyword">if</span>(laggingReplicas.size &gt; <span class="number">0</span>)</div><div class="line">    debug(<span class="string">"Lagging replicas for partition %s are %s"</span>.format(<span class="type">TopicAndPartition</span>(topic, partitionId), laggingReplicas.map(_.brokerId).mkString(<span class="string">","</span>)))</div><div class="line">  laggingReplicas</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ã€€ã€€åœ¨getOutOfSyncReplicaså‡½æ•°çš„æ³¨é‡Šä¸­æŠŠreplicaå‰”é™¤ISRçš„æƒ…å†µè¯´çš„æ¯”è¾ƒæ¸…æ¥šã€‚<br>ã€€ã€€1.è¿™ä¸ªreplica fetchçš„è¿›ç¨‹stuckä½äº†ï¼Œè¯¥replicaçš„leoè¶…è¿‡maxLagMsæ²¡æœ‰æ›´æ–°äº†ã€‚<br>ã€€ã€€2. followerçš„æ‹·è´é€Ÿåº¦è¿œè¿œè·Ÿä¸ä¸Šleaderçš„å†™å…¥é€Ÿåº¦ï¼Œå·²ç»æŒç»­è½åäº†maxLagMsã€‚<br>ã€€ã€€è¿™ä¸¤ç§æƒ…å†µéƒ½å¯ä»¥ç”¨lastCaughtUpTimeMsæ¥è®¡æ—¶ï¼Œè¿™ä¸ªå‚æ•°ä»£è¡¨äº†è¿™ä¸ªreplicaä¸Šä¸€æ¬¡å®Œå…¨è¿½ä¸Šleaderçš„æ—¶é—´æˆ³ã€‚<br>ã€€ã€€æ¥ç€æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ISRä¸­åªå‰©ä¸‹2ï¼Œè€Œ2åˆå®•æœºäº†ï¼Œè‚¿ä¹ˆåŠï¼Œå…¶å®æ­¤åˆ»è¯¥åˆ†åŒºè¿˜æ˜¯å¯ä»¥ç”¨çš„ï¼Œå› ä¸ºé»˜è®¤å¼€å¯äº†unclean.leader.election.enableè¿™ä¸ªåŠŸèƒ½ï¼Œå…è®¸è¿›è¡Œuncleané€‰ä¸¾ï¼Œæœªèƒ½åŠæ—¶åŒæ­¥çš„replica 3è¢«é€‰ä¸¾ä¸ºleaderï¼Œå¯ä»¥çœ‹å¦‚ä¸‹æ—¥å¿—ã€‚å‘ç”Ÿuncleané€‰ä¸¾çš„å±å®³ä¸åªåœ¨offsetä¼šå‘ç”Ÿå€’é€€ï¼Œè€Œä¸”æœªèƒ½åŒæ­¥åˆ°replicaçš„æ•°æ®åŸºæœ¬ä¸Šå°±ä¸¢å¤±äº†ã€‚é‚£ä¹ˆæŠŠè¿™ä¸ªåŠŸèƒ½å…³äº†ä¸å°±okäº†å—ï¼Ÿè‡ªå¤ç¾äº‹ä¸¤éš¾å…¨ï¼Œæˆ‘ä»¬åœ¨ä¸‹ä¸€èŠ‚æ¥ç»†è¯´è¿™ä¸ªUnclean leader electionã€‚<br><img src="http://ol7f62vwl.bkt.clouddn.com/unclean.png" alt="unclean-log"></p>
<h2 id="å…¶ä»–é—®é¢˜"><a href="#å…¶ä»–é—®é¢˜" class="headerlink" title="å…¶ä»–é—®é¢˜"></a>å…¶ä»–é—®é¢˜</h2><p>ã€€ã€€å…¶å®é€ æˆoffset rewindsçš„é—®é¢˜æ˜¯å¹¶ä¸å±€é™äºunclean leader electionï¼Œ<a href="http://i.dataguru.cn/mportal.php?mod=view&amp;aid=9468" target="_blank" rel="external">å‰–æLinkedlné­é‡çš„Kafkaâ€œå±æœºæ•…éšœâ€</a>è¿™ç¯‡æ–‡ç« ä¸­ä¹Ÿä»‹ç»äº†LinkedInä¹‹å‰é‡åˆ°çš„ä¸€äº›Bugçº§åˆ«ï¼ˆç›®å‰å·²ä¿®å¤ï¼‰çš„offset rewindsï¼Œä»¥ä¾›å‚è€ƒã€‚</p>
<h1 id="Kafkaæ•°æ®ä¸¢å¤±ï¼Ÿ"><a href="#Kafkaæ•°æ®ä¸¢å¤±ï¼Ÿ" class="headerlink" title="Kafkaæ•°æ®ä¸¢å¤±ï¼Ÿ"></a>Kafkaæ•°æ®ä¸¢å¤±ï¼Ÿ</h1><h2 id="Unclean-leader-election"><a href="#Unclean-leader-election" class="headerlink" title="Unclean leader election"></a>Unclean leader election</h2><p>ã€€ã€€æ˜¯å¦å…è®¸uncleané€‰ä¸¾å…¶å®ä¹Ÿæ˜¯å¯ç”¨æ€§å’Œæ•°æ®ä¸€è‡´æ€§çš„trade-offé—®é¢˜ã€‚å®˜æ–¹æ–‡æ¡£é’ˆå¯¹uncleané€‰ä¸¾æœ‰è¿™ä¹ˆä¸€æ®µï¼Œæˆ‘ç»“åˆè‡ªå·±çš„ç†è§£æ¥ç¿»è¯‘ä¸€ä¸‹ã€‚</p>
<blockquote>
<p><strong>Unclean leader election: What if they all die?</strong><br>Note that Kafkaâ€™s guarantee with respect to data loss is predicated on at least one replica remaining in sync. If all the nodes replicating a partition die, this guarantee no longer holds.<br>However a practical system needs to do something reasonable when all the replicas die. If you are unlucky enough to have this occur, it is important to consider what will happen. There are two behaviors that could be implemented:</p>
<ol>
<li>Wait for a replica in the ISR to come back to life and choose this replica as the leader (hopefully it still has all its data).</li>
<li>Choose the first replica (not necessarily in the ISR) that comes back to life as the leader.</li>
</ol>
<p>This is a simple tradeoff between availability and consistency. If we wait for replicas in the ISR, then we will remain unavailable as long as those replicas are down. If such replicas were destroyed or their data was lost, then we are permanently down. If, on the other hand, a non-in-sync replica comes back to life and we allow it to become leader, then its log becomes the source of truth even though it is not guaranteed to have every committed message. By default Kafka chooses the second strategy and favor choosing a potentially inconsistent replica when all replicas in the ISR are dead. This behavior can be disabled using configuration property unclean.leader.election.enable, to support use cases where downtime is preferable to inconsistency.</p>
<p>This dilemma is not specific to Kafka. It exists in any quorum-based scheme. For example in a majority voting scheme, if a majority of servers suffer a permanent failure, then you must either choose to lose 100% of your data or violate consistency by taking what remains on an existing server as your new source of truth.</p>
</blockquote>
<p>ã€€ã€€éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œkafkaå¯¹äºæ•°æ®ä¸¢å¤±çš„ä¿éšœæ˜¯åŸºäºISRä¸­è‡³å°‘ä¸€ä¸ªå‰¯æœ¬åœ¨ä¿æŒåŒæ­¥ã€‚å¦‚æœè¯¥åˆ†åŒºä¸Šæ‰€æœ‰çš„å‰¯æœ¬ç»“ç‚¹éƒ½æŒ‚äº†ï¼Œé‚£è¿™ä¿è¯å°±ä¸å†æˆç«‹äº†ã€‚ç„¶åå®é™…ç³»ç»Ÿéœ€è¦å¯¹æ‰€æœ‰replica dieçš„æƒ…å†µè¿›è¡Œå¤„ç†ã€‚å¦‚æœä½ äººå“ä¸å¥½é‡åˆ°äº†è¿™ç§æƒ…å†µï¼Œéœ€è¦è€ƒè™‘ä»¥ä¸‹ä¸¤ç§å¤„ç†æ–¹å¼ï¼Œå°±å˜å¾—è‡³å…³é‡è¦äº†ï¼š</p>
<ol>
<li>ç­‰ç€ISRä¸­çš„ä¸€ä¸ªå‰¯æœ¬æ´»è¿‡æ¥ï¼Œå¹¶é€‰ä¸¾å®ƒä¸ºleader</li>
<li>é€‰æ‹©ç¬¬ä¸€ä¸ªæ´»è¿‡æ¥çš„å‰¯æœ¬ï¼ˆä¸ä¸€å®šåœ¨ISRä¸­ï¼‰ä½œä¸ºleader</li>
</ol>
<p>ã€€ã€€å…¶å®è¿™å°±æ˜¯é’ˆå¯¹å¯ç”¨æ€§å’Œä¸€è‡´æ€§çš„ç®€å•æƒè¡¡äº†ã€‚å¦‚æœé€‰æ‹©ç­‰å¾…ISRä¸­çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œé‚£ä¹ˆåªè¦ISRä¸­çš„replicaä¸€ç›´downï¼Œokï¼Œé‚£ä¹ˆè¿™ä¸ªåˆ†åŒºå°±ä¸å¯ç”¨ï¼Œå¦‚æœè¿™äº›replicaæŸåæˆ–è€…æ•°æ®ä¸¢å¤±ï¼ˆç®¡å®ƒä»€ä¹ˆåŸå› ï¼‰ï¼Œé‚£å°±æ˜¯æ°¸ä¹…çš„ä¸å¯ç”¨äº†ã€‚å¦ä¸€ä¸ªæ–¹é¢ï¼Œå¦‚æœæˆ‘ä»¬é€‰æ‹©äº†ä¸€ä¸ªä¸æ˜¯ISRä¸­çš„replicaä½œä¸ºleaderï¼Œé‚£å®ƒçš„logå°†æˆä¸ºæ•°æ®æºï¼Œå³ä½¿å®ƒçš„logä¸­å¹¶ä¸èƒ½å¤Ÿä¿è¯æ‹¥æœ‰æ¯æ¡å·²ç»è¢«commitedçš„æ¶ˆæ¯ã€‚ç›®å‰æˆ‘ä»¬ç”¨çš„ç‰ˆæœ¬ä¸­é»˜è®¤æ˜¯é€‰æ‹©äº†ç¬¬äºŒç§å¤„ç†æ–¹å¼ï¼Œå¦‚æœISRä¸­çš„æ‰€æœ‰replicaæŒ‚äº†å°±é€‰æ‹©äº†ä¸€ä¸ªæ½œåœ¨æ•°æ®ä¸ä¸€è‡´çš„replicaä½œä¸ºleaderã€‚å¦‚æœæˆ‘ä»¬å¯¹äºæ•°æ®ä¸€è‡´æ€§çš„è¦æ±‚æ¯”å®•æœºå¯ç”¨æ€§çš„è¦æ±‚æ›´é«˜ï¼Œå°±å¯ä»¥é€šè¿‡unclean.leader.election.enable=falseç¦ç”¨æ‰ï¼Œè¿™ä¸ªå¯ä»¥ç»†åŒ–åˆ°æŸä¸ªtopicçº§åˆ«ã€‚è¿™é‡Œæˆ‘å¤šè¯´ä¸€å¥ä»€ä¹ˆæ˜¯committedæ¶ˆæ¯ï¼Œå¦‚æœä¸€æ¡æ¶ˆæ¯è¢«ISRä¸­æ‰€æœ‰çš„replicaè®°å½•åˆ°logä¸­ï¼Œé‚£ä¹ˆè¿™æ¡æ¶ˆæ¯å°±è¢«è®¤ä¸ºæ˜¯committedçš„ï¼Œå¯¹äºconsumerç«¯è€Œè¨€ï¼Œåªæœ‰è¢«committedçš„æ¶ˆæ¯æ‰èƒ½è¢«çœ‹åˆ°ï¼Œè€ŒHigh Watermarkå°±æ˜¯æœ€æ–°çš„çš„ä¸€æ¡committed messageçš„ä½ç§»ã€‚<br>ã€€ã€€è¿™ç§çª˜å¢ƒä¹Ÿä¸åªKafkaå­˜åœ¨ï¼Œä»»ä½•åŸºäºquorumçš„æ–¹æ¡ˆä¸­éƒ½ä¼šå­˜åœ¨ã€‚ä¾‹å¦‚åœ¨å¤šæ•°æŠ•ç¥¨çš„æ–¹æ¡ˆä¸­ï¼Œå¦‚æœå¤šæ•°çš„æœåŠ¡å™¨å°†å¯èƒ½æ°¸ä¹…ä¸å¯ç”¨ï¼Œä½ æ˜¯é€‰æ‹©100%ä¸¢å¤±æ•°æ®å‘¢ï¼Ÿè¿˜æ˜¯è¿åä¸€è‡´æ€§ï¼Œç”¨å¹¸å­˜çš„æœåŠ¡å™¨ä¸Šè¿˜æœ‰çš„æ•°æ®ä½œä¸ºæ–°çš„æ•°æ®æºï¼Ÿ</p>
<h2 id="Producerç«¯æ•°æ®ä¸¢å¤±ï¼Ÿ"><a href="#Producerç«¯æ•°æ®ä¸¢å¤±ï¼Ÿ" class="headerlink" title="Producerç«¯æ•°æ®ä¸¢å¤±ï¼Ÿ"></a>Producerç«¯æ•°æ®ä¸¢å¤±ï¼Ÿ</h2><p>ã€€ã€€æ—¢ç„¶åœ¨æœªåŒæ­¥çš„replicaä¸­é€‰ä¸¾leaderä¼šå‘ç”Ÿæ•°æ®ä¸¢å¤±ï¼Œé‚£ä¹ˆä»ISRä¸­è¿›è¡Œleaderé€‰ä¸¾æ˜¯å¦å°±100%ä¿è¯æ•°æ®å®Œæ•´äº†å‘¢ï¼ŸNative~~æˆ‘ä»¬å†æ¥çœ‹è¿™ç§æƒ…å†µï¼š<br>ã€€ã€€<code>ACK=1ï¼ŒISR=(1,2,3), leader=1</code><br>ã€€ã€€replica 1ä½œä¸ºleaderå·²ç»ç¡®è®¤äº†producerçš„ä¸€äº›recordså†™å…¥local logï¼Œå¹¶æˆåŠŸè¿”å›ç»™äº†producerå“åº”ã€‚æ­¤æ—¶leader failureï¼Œä¸”follower 2å’Œ3è¿˜æ²¡æ¥å¾—åŠå¤åˆ¶è¿™äº›recordsã€‚é‡æ–°é€‰ä¸¾ï¼ŒISR=(2,3)ï¼Œå…¶ä¸­2å½“é€‰leaderï¼ŒmakeLeaderçš„è¿‡ç¨‹ä¸­HWè¿˜æ˜¯ä¿æŒäº†ä¹‹å‰çš„æ—§å€¼ã€‚æ¥ç€1æ´»è¿‡æ¥äº†ï¼Œæˆä¸ºfollowerï¼Œæˆªæ–­è‡ªå·±çš„logè‡³HWï¼Œreplica 1çš„HWè‡³leoçš„æ•°æ®ä¹Ÿå°±è¢«æŠ›å¼ƒäº†ï¼Œå› æ­¤ä¹‹å‰å†™å…¥replica 1ä½†è¿˜æœªåŒæ­¥åˆ°replica 2çš„æ•°æ®ä¹Ÿå°±å½»åº•ä¸¢å¤±äº†ã€‚replica 1æ²¡æœ‰æ´»è¿‡æ¥ï¼Œå½“ç„¶æ•°æ®ä¹Ÿä¸¢å¤±äº†ã€‚<br>ã€€ã€€è§£å†³åŠæ³•æ˜¯ï¼Œproducerç«¯è®¾ç½®ACK=all(-1)ï¼Œbrokerç«¯é’ˆå¯¹å…·ä½“çš„topicè®¾ç½®min.insync.replicas=2ï¼Œè¿™æ ·produceråªæœ‰ç­‰å¾…ISRä¸­è‡³å°‘ä¸¤ä¸ªreplicaå·²ç»ç¡®è®¤å†™å…¥äº†è¿™æ¡æ¶ˆæ¯ï¼Œæ‰ä¼šç»™producerè¿”å›æ­£ç¡®å“åº”ã€‚å¦‚æœè¯¥æ¡ä»¶æ— æ³•æ»¡è¶³ï¼Œåˆ™è§¦å‘å¼‚å¸¸ã€‚å½“ç„¶äº†ï¼Œproducerç«¯è¿™ä¹ˆè®¾ç½®ä¹‹åï¼Œæ•°æ®å®Œæ•´æ€§æ˜æ˜¾é«˜äº†è®¸å¤šï¼Œæ¢æ¥çš„å¿…ç„¶æ˜¯ååé‡çš„ä¸‹é™ï¼Œå“ï¼Œè¿™åˆæ˜¯ä¸€ä¸ªtrade-offçš„é—®é¢˜å•Šã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ã€€ã€€æœ¬æ–‡é’ˆå¯¹unclean leaderé€‰ä¸¾é€ æˆçš„offset rewindsæƒ…å†µè¿›è¡Œäº†å®é™…çš„åˆ†æï¼Œè¿›è€Œå¼•å‡ºäº†kafkaä¸¢å¤±æ•°æ®çš„å„ç§æƒ…å†µã€‚Howeverï¼Œé’ˆå¯¹ä¸åŒçš„ä¸šåŠ¡åœºæ™¯è¿›è¡Œå¯ç”¨æ€§ä¸æ•°æ®ä¸€è‡´æ€§çš„æƒè¡¡ã€ååé‡ä¸æ•°æ®å®Œæ•´æ€§çš„æƒè¡¡ï¼Œæ˜¯éå¸¸é‡è¦çš„ã€‚æœ€é‡è¦çš„è¿˜æ˜¯ä¿è¯Kafkaé›†ç¾¤çš„çš„ç¨³å®šå’Œå¥åº·ã€‚</p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>å…„å¼Ÿï¼Œè¯·æˆ‘å–ç“¶è¥å…»å¿«çº¿ï¼Ÿ</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>èµ</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="http://oj5mvdqpa.bkt.clouddn.com/weixin-pay.png" alt="Gemini WeChat Pay"/>
          <p>å¾®ä¿¡æ‰“èµ</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="http://oj5mvdqpa.bkt.clouddn.com/zhifubao-pay.png" alt="Gemini Alipay"/>
          <p>æ”¯ä»˜å®æ‰“èµ</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Kafka/" rel="tag">#Kafka</a>
          
            <a href="/tags/æ•°æ®ä¸€è‡´æ€§/" rel="tag">#æ•°æ®ä¸€è‡´æ€§</a>
          
            <a href="/tags/é«˜å¯ç”¨æ€§/" rel="tag">#é«˜å¯ç”¨æ€§</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/02/26/å‘¨æœ«çæ‰¯æ·¡/" rel="next" title="å‘¨æœ«çæ‰¯æ·¡">
                <i class="fa fa-chevron-left"></i> å‘¨æœ«çæ‰¯æ·¡
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/03/04/jinganglang3-Logan/" rel="prev" title="17å¹´ï¼Œç‹¼å”å†è§">
                17å¹´ï¼Œç‹¼å”å†è§ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="2017/02/28/kafka-offset-rewinds-offset-lost/"
     data-title="Kafka Offsetå€’å›å’Œæ•°æ®ä¸¢å¤±ï¼Ÿ"
     data-content=""
     data-url="https://geminiguy.github.io/2017/02/28/kafka-offset-rewinds-offset-lost/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">åˆ†äº«åˆ°ï¼š</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">å¾®åš</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQç©ºé—´</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">è…¾è®¯å¾®åš</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">å¾®ä¿¡</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/02/28/kafka-offset-rewinds-offset-lost/"
           data-title="Kafka Offsetå€’å›å’Œæ•°æ®ä¸¢å¤±ï¼Ÿ" data-url="https://geminiguy.github.io/2017/02/28/kafka-offset-rewinds-offset-lost/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://oj5mvdqpa.bkt.clouddn.com/gemini.jpeg"
               alt="Gemini" />
          <p class="site-author-name" itemprop="name">Gemini</p>
          <p class="site-description motion-element" itemprop="description">å˜˜ï¼Œè¦å‘è½¦äº†</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">12</span>
              <span class="site-state-item-name">æ—¥å¿—</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/GeminiGuy" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/2509862211/" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:rockere6@163.com" target="_blank" title="Email">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                  Email
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#åºè¨€"><span class="nav-number">1.</span> <span class="nav-text">åºè¨€</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kafka-Offset-Rewinds"><span class="nav-number">2.</span> <span class="nav-text">Kafka Offset Rewinds</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Offset-Rewindsæ¦‚å¿µ"><span class="nav-number">2.1.</span> <span class="nav-text">Offset Rewindsæ¦‚å¿µ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç°è±¡reviewåŠæ’æŸ¥"><span class="nav-number">2.2.</span> <span class="nav-text">ç°è±¡reviewåŠæ’æŸ¥</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å…¶ä»–é—®é¢˜"><span class="nav-number">2.3.</span> <span class="nav-text">å…¶ä»–é—®é¢˜</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kafkaæ•°æ®ä¸¢å¤±ï¼Ÿ"><span class="nav-number">3.</span> <span class="nav-text">Kafkaæ•°æ®ä¸¢å¤±ï¼Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Unclean-leader-election"><span class="nav-number">3.1.</span> <span class="nav-text">Unclean leader election</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Producerç«¯æ•°æ®ä¸¢å¤±ï¼Ÿ"><span class="nav-number">3.2.</span> <span class="nav-text">Producerç«¯æ•°æ®ä¸¢å¤±ï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#æ€»ç»“"><span class="nav-number">4.</span> <span class="nav-text">æ€»ç»“</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Gemini</span>
</div>

<div class="powered-by">
  ç”± <a class="theme-link" href="http://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"geminiguy"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
      
      <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
      <script src="/js/src/hook-duoshuo.js"></script>
    
  





  
  
  

  

  

</body>
</html>
